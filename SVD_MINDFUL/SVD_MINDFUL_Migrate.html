<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SVD MINDFUL - ãƒ‡ãƒ¼ã‚¿ç§»è¡Œãƒ„ãƒ¼ãƒ« v2</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Inter:wght@400;500;600&family=Noto+Sans+JP:wght@400;500;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --navy: #1a365d;
            --gold: #c9a962;
            --white: #ffffff;
            --light-gray: #f7f8fa;
            --text-gray: #6b7280;
            --success: #22c55e;
            --danger: #ef4444;
            --border: #e5e7eb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            background: linear-gradient(135deg, #1a365d 0%, #2d4a7c 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--navy);
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding-top: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-family: 'Montserrat', sans-serif;
            color: var(--gold);
            font-size: 24px;
            font-weight: 700;
            letter-spacing: 0.1em;
        }

        .header p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 13px;
            margin-top: 8px;
        }

        .card {
            background: var(--white);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .step-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: var(--gold);
            letter-spacing: 0.1em;
            margin-bottom: 15px;
        }

        .data-display {
            background: var(--light-gray);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .data-row:last-child {
            margin-bottom: 0;
        }

        .data-label {
            color: var(--text-gray);
        }

        .data-value {
            font-weight: 600;
            color: var(--navy);
        }

        .token-highlight {
            color: var(--gold);
            font-size: 20px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-gray);
            margin-bottom: 6px;
            letter-spacing: 0.05em;
        }

        .text-input {
            width: 100%;
            padding: 14px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s;
        }

        .text-input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(201, 169, 98, 0.2);
        }

        .pin-input {
            letter-spacing: 0.4em;
            text-align: center;
            font-size: 20px;
            font-weight: 600;
        }

        .btn-main {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--gold) 0%, #d4b978 100%);
            color: var(--navy);
            border: none;
            border-radius: 12px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 14px;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
        }

        .btn-main:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(201, 169, 98, 0.4);
        }

        .btn-main:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            width: 100%;
            padding: 14px;
            background: var(--light-gray);
            color: var(--navy);
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 13px;
            cursor: pointer;
            margin-top: 10px;
        }

        .message {
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            font-size: 12px;
            margin-top: 15px;
            display: none;
        }

        .message.error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            display: block;
        }

        .message.success {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success);
            display: block;
        }

        .message.hidden {
            display: none;
        }

        .warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 10px;
            padding: 12px;
            font-size: 11px;
            color: #92400e;
            margin: 15px 0;
        }

        .instructions {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .instructions h3 {
            font-size: 13px;
            color: var(--navy);
            margin-bottom: 12px;
        }

        .instructions ol {
            font-size: 12px;
            color: var(--text-gray);
            padding-left: 20px;
            line-height: 1.8;
        }

        .base-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .base-option {
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .base-option:hover {
            border-color: var(--gold);
        }

        .base-option.selected {
            border-color: var(--gold);
            background: rgba(201, 169, 98, 0.1);
        }

        .base-icon {
            font-size: 24px;
        }

        .base-name {
            font-size: 12px;
            font-weight: 600;
            margin-top: 4px;
        }

        #step2,
        #step3 {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--text-gray);
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”„ MINDFUL</h1>
            <p>ãƒ‡ãƒ¼ã‚¿ç§»è¡Œãƒ„ãƒ¼ãƒ« v2</p>
        </div>

        <div class="card">
            <!-- STEP 1: åå‰å…¥åŠ› -->
            <div id="step1">
                <div class="step-title">STEP 1: åå‰ã‚’å…¥åŠ›</div>
                <p style="font-size: 12px; color: var(--text-gray); margin-bottom: 15px;">
                    MINDFULã«ç™»éŒ²ã—ãŸåå‰ã‚’æ­£ç¢ºã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>
                    ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰ã‚ãªãŸã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢ã—ã¾ã™ã€‚
                </p>

                <div class="input-group">
                    <label class="input-label">YOUR NAME</label>
                    <input type="text" class="text-input" id="inputName" placeholder="ä¾‹: å±±ç”°å¤ªéƒ">
                </div>

                <div class="input-group">
                    <label class="input-label">æ‹ ç‚¹ã‚’é¸æŠ</label>
                    <div class="base-selector">
                        <div class="base-option" data-base="moiwayama" onclick="selectBase(this)">
                            <div class="base-icon">ğŸ”ï¸</div>
                            <div class="base-name">è—»å²©å±±</div>
                        </div>
                        <div class="base-option" data-base="okurayama" onclick="selectBase(this)">
                            <div class="base-icon">â›·ï¸</div>
                            <div class="base-name">å¤§å€‰å±±</div>
                        </div>
                        <div class="base-option" data-base="tvtower" onclick="selectBase(this)">
                            <div class="base-icon">ğŸ—¼</div>
                            <div class="base-name">ãƒ†ãƒ¬ãƒ“å¡”</div>
                        </div>
                        <div class="base-option" data-base="akarenga" onclick="selectBase(this)">
                            <div class="base-icon">ğŸ§±</div>
                            <div class="base-name">èµ¤ã‚Œã‚“ãŒ</div>
                        </div>
                    </div>
                </div>

                <button class="btn-main" id="searchBtn" onclick="searchUser()">ğŸ” ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢</button>
                <div id="step1Error" class="message hidden"></div>
            </div>

            <!-- STEP 2: ãƒ‡ãƒ¼ã‚¿ç¢ºèª & PINè¨­å®š -->
            <div id="step2">
                <div class="step-title">STEP 2: ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª</div>
                <div class="data-display">
                    <div class="data-row">
                        <span class="data-label">åå‰</span>
                        <span class="data-value" id="foundName">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">æ‹ ç‚¹</span>
                        <span class="data-value" id="foundBase">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">ãƒˆãƒ¼ã‚¯ãƒ³</span>
                        <span class="data-value token-highlight">ğŸª™ <span id="foundTokens">0</span></span>
                    </div>
                </div>

                <div class="step-title" style="margin-top: 20px;">STEP 3: PINã‚’è¨­å®š</div>
                <div class="warning">
                    âš ï¸ ã“ã®PINã¯ãƒ‡ãƒ¼ã‚¿å¾©å…ƒã«å¿…è¦ã§ã™ã€‚å¿…ãšè¦šãˆã¦ãŠã„ã¦ãã ã•ã„ï¼
                </div>

                <div class="input-group">
                    <label class="input-label">4æ¡ã®PINã‚’å…¥åŠ›</label>
                    <input type="password" class="text-input pin-input" id="newPin" placeholder="1234" maxlength="4"
                        pattern="[0-9]*" inputmode="numeric">
                </div>
                <div class="input-group">
                    <label class="input-label">PINã‚’ç¢ºèªï¼ˆã‚‚ã†ä¸€åº¦ï¼‰</label>
                    <input type="password" class="text-input pin-input" id="confirmPin" placeholder="1234" maxlength="4"
                        pattern="[0-9]*" inputmode="numeric">
                </div>

                <button class="btn-main" id="migrateBtn" onclick="migrateData()">ğŸ” ç§»è¡Œå®Œäº† & PINè¨­å®š</button>
                <button class="btn-secondary" onclick="goBack()">â† æˆ»ã‚‹</button>
                <div id="step2Error" class="message hidden"></div>
            </div>

            <!-- STEP 3: å®Œäº† -->
            <div id="step3">
                <div style="text-align: center; padding: 20px 0;">
                    <div style="font-size: 60px; margin-bottom: 15px;">âœ…</div>
                    <div class="step-title" style="color: var(--success);">ç§»è¡Œå®Œäº†ï¼</div>
                    <div id="successInfo" style="font-size: 13px; color: var(--navy); margin: 15px 0;"></div>
                </div>

                <div class="instructions">
                    <h3>ğŸ“‹ æ¬¡ã®æ‰‹é †</h3>
                    <ol>
                        <li>ãƒ›ãƒ¼ãƒ ç”»é¢ã®MINDFULã‚’<strong>å‰Šé™¤</strong></li>
                        <li>Safariã§æ–°ã—ã„MINDFULã‚’é–‹ã</li>
                        <li>ã€ŒğŸ”‘ ãƒ­ã‚°ã‚¤ãƒ³ã€ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—</li>
                        <li>åå‰ã¨PINã‚’å…¥åŠ›ã—ã¦å¾©å…ƒï¼</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URLS = {
            moiwayama: 'https://script.google.com/macros/s/AKfycbyWS3GJ_0MaRQORqQxRqP5dGehIhz94C4YN5O23sXnZAHqSZjn0WfxMnmYn8GLQW2oWtg/exec',
            okurayama: 'https://script.google.com/macros/s/AKfycbwp-_wJBz4KZoVFXKBwz3FG5Xr3hU03JJI4f8OvLW4T_kKTHjEfqmF1hNlYNOZ44VSe/exec',
            tvtower: 'https://script.google.com/macros/s/AKfycbzq_RaJcldhv8S2M0zCiO2J8dIqnc2W1wVAjlxX7jJFSxvPmYXZtJDn3Fq5YKk7Uy4d/exec',
            akarenga: ''
        };

        const BASE_NAMES = {
            moiwayama: 'è—»å²©å±±',
            okurayama: 'å¤§å€‰å±±',
            tvtower: 'ãƒ†ãƒ¬ãƒ“å¡”',
            akarenga: 'èµ¤ã‚Œã‚“ãŒ'
        };

        let selectedBase = '';
        let foundUserData = null;

        function selectBase(el) {
            document.querySelectorAll('.base-option').forEach(o => o.classList.remove('selected'));
            el.classList.add('selected');
            selectedBase = el.dataset.base;
        }

        async function searchUser() {
            const name = document.getElementById('inputName').value.trim();
            const errorEl = document.getElementById('step1Error');
            const btn = document.getElementById('searchBtn');

            errorEl.className = 'message hidden';

            if (!name) {
                errorEl.textContent = 'åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                errorEl.className = 'message error';
                return;
            }

            if (!selectedBase) {
                errorEl.textContent = 'æ‹ ç‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„';
                errorEl.className = 'message error';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'æ¤œç´¢ä¸­...';

            const url = SCRIPT_URLS[selectedBase];
            if (!url) {
                errorEl.textContent = 'ã“ã®æ‹ ç‚¹ã¯ã¾ã å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“';
                errorEl.className = 'message error';
                btn.disabled = false;
                btn.textContent = 'ğŸ” ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢';
                return;
            }

            try {
                const response = await fetch(`${url}?action=lookupUser&name=${encodeURIComponent(name)}`);
                const result = await response.json();

                if (result.success) {
                    foundUserData = result;

                    document.getElementById('foundName').textContent = result.name;
                    document.getElementById('foundBase').textContent = BASE_NAMES[result.base] || result.base || selectedBase;
                    document.getElementById('foundTokens').textContent = result.tokenBalance || 0;

                    document.getElementById('step1').style.display = 'none';
                    document.getElementById('step2').style.display = 'block';
                } else {
                    errorEl.textContent = result.error || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                    errorEl.className = 'message error';
                }
            } catch (e) {
                console.error('Search error:', e);
                errorEl.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
                errorEl.className = 'message error';
            }

            btn.disabled = false;
            btn.textContent = 'ğŸ” ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢';
        }

        function goBack() {
            document.getElementById('step2').style.display = 'none';
            document.getElementById('step1').style.display = 'block';
        }

        async function migrateData() {
            const newPin = document.getElementById('newPin').value.trim();
            const confirmPin = document.getElementById('confirmPin').value.trim();
            const errorEl = document.getElementById('step2Error');
            const btn = document.getElementById('migrateBtn');

            errorEl.className = 'message hidden';

            if (!newPin || newPin.length !== 4 || !/^\d{4}$/.test(newPin)) {
                errorEl.textContent = 'PINã¯4æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„';
                errorEl.className = 'message error';
                return;
            }

            if (newPin !== confirmPin) {
                errorEl.textContent = 'PINãŒä¸€è‡´ã—ã¾ã›ã‚“';
                errorEl.className = 'message error';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'ç§»è¡Œä¸­...';

            const url = SCRIPT_URLS[selectedBase];

            try {
                // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«ç™»éŒ²
                const registerUrl = `${url}?action=register&name=${encodeURIComponent(foundUserData.name)}&pin=${encodeURIComponent(newPin)}&base=${encodeURIComponent(foundUserData.base || selectedBase)}`;
                const response = await fetch(registerUrl);
                const result = await response.json();

                if (result.success || result.exists) {
                    // æˆåŠŸï¼
                    document.getElementById('successInfo').innerHTML = `
                        <strong>åå‰:</strong> ${foundUserData.name}<br>
                        <strong>PIN:</strong> ${newPin}<br>
                        <strong>ãƒˆãƒ¼ã‚¯ãƒ³:</strong> ğŸª™ ${foundUserData.tokenBalance || 0}
                    `;

                    document.getElementById('step2').style.display = 'none';
                    document.getElementById('step3').style.display = 'block';
                } else {
                    throw new Error(result.error || 'ç§»è¡Œã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (e) {
                console.error('Migration error:', e);
                errorEl.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + e.message;
                errorEl.className = 'message error';
                btn.disabled = false;
                btn.textContent = 'ğŸ” ç§»è¡Œå®Œäº† & PINè¨­å®š';
            }
        }
    </script>
</body>

</html>