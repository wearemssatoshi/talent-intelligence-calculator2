<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVD Growth Comparison | ÊàêÈï∑ÊØîËºÉ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Montserrat:wght@300;400;500;600;700;800;900&display=swap');

        :root {
            --primary-color: #0f172a;
            --secondary-color: #B8995C;
            --accent-color: #D4AF37;
            --background-color: #f8fafc;
            --text-color: #1e293b;
            --light-text-color: #64748b;
            --border-color: #e2e8f0;
            --card-bg: #FFFFFF;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.1);
            --growth-positive: #10b981;
            --growth-negative: #ef4444;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.7;
            padding: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem 0;
        }

        .header-logo {
            width: 150px;
            height: auto;
            margin-bottom: 1rem;
            opacity: 0.9;
        }

        header h1 {
            font-family: 'Montserrat', sans-serif;
            color: var(--primary-color);
            font-weight: 800;
            font-size: 2rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        header p {
            color: var(--secondary-color);
            font-size: 0.9rem;
            letter-spacing: 0.15em;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .search-section {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .input-group {
            flex: 1;
            min-width: 200px;
        }

        .input-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }

        .input-group select,
        .input-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
            font-family: inherit;
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        .btn-success {
            background: #10b981;
        }

        .btn-success:hover {
            background: #059669;
        }

        .section-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--secondary-color);
        }

        /* Comparison Table */
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2rem;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 1rem;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .comparison-table th {
            background: var(--primary-color);
            color: white;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
        }

        .comparison-table .row-header {
            background: #f8fafc;
            font-weight: 600;
            text-align: left;
        }

        .growth-positive {
            color: var(--growth-positive);
            font-weight: 600;
        }

        .growth-negative {
            color: var(--growth-negative);
            font-weight: 600;
        }

        /* Progress Bars Section */
        .skills-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .skill-category {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 12px;
            border-left: 4px solid var(--secondary-color);
        }

        .skill-category-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .skill-item {
            margin-bottom: 0.75rem;
        }

        .skill-item:last-child {
            margin-bottom: 0;
        }

        .skill-label {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 0.3rem;
            font-size: 0.8rem;
        }

        .skill-name {
            font-weight: 600;
            color: var(--primary-color);
        }

        .skill-name span {
            font-weight: 400;
            color: var(--light-text-color);
            margin-left: 0.3rem;
        }

        .skill-values {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .skill-bars {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .bar-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .bar-label {
            font-size: 0.65rem;
            color: var(--light-text-color);
            width: 40px;
        }

        .bar-track {
            flex: 1;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .bar-fill-before {
            height: 100%;
            background: linear-gradient(90deg, #94a3b8, #cbd5e1);
            border-radius: 4px;
            transition: width 0.8s ease;
        }

        .bar-fill-after {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary-color), var(--accent-color));
            border-radius: 4px;
            transition: width 0.8s ease;
        }

        .growth-badge {
            font-size: 0.7rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
            min-width: 40px;
            text-align: center;
        }

        .growth-badge.positive {
            background: rgba(16, 185, 129, 0.15);
            color: var(--growth-positive);
        }

        .growth-badge.negative {
            background: rgba(239, 68, 68, 0.15);
            color: var(--growth-negative);
        }

        .growth-badge.neutral {
            background: rgba(100, 116, 139, 0.15);
            color: var(--light-text-color);
        }

        /* Results Dashboard */
        #results-section {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--light-text-color);
        }

        .no-data {
            text-align: center;
            padding: 2rem;
            color: var(--light-text-color);
            background: #fef3c7;
            border-radius: 8px;
        }

        /* Footer */
        footer {
            text-align: center;
            margin-top: 4rem;
            padding: 2rem 0;
            border-top: 1px solid var(--border-color);
        }

        footer p {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.8rem;
            color: var(--light-text-color);
            letter-spacing: 0.15em;
        }

        @media (max-width: 768px) {
            .chart-container {
                grid-template-columns: 1fr;
            }

            .search-section {
                flex-direction: column;
            }
        }

        @media print {
            body {
                background: white;
                padding: 1rem;
            }

            .no-print {
                display: none !important;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <img src="../logo/SVD_logo_Black.png" alt="SVD Logo" class="header-logo">
            <h1>Growth Comparison</h1>
            <p>ÊàêÈï∑ÊØîËºÉ„É¨„Éù„Éº„Éà</p>
        </header>

        <!-- Search Section -->
        <div class="card no-print">
            <h3 class="section-title">„Çπ„Çø„ÉÉ„ÉïÊ§úÁ¥¢</h3>

            <!-- Mode Tabs -->
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem;">
                <button id="mode-growth" class="btn" style="flex: 1; background: var(--primary-color);">üìà ÊàêÈï∑Êé®Áßª</button>
                <button id="mode-vs" class="btn" style="flex: 1; background: #64748b;">‚öîÔ∏è VSÊØîËºÉ</button>
            </div>

            <div class="search-section">
                <div class="input-group">
                    <label for="gas-url">GAS URL</label>
                    <input type="text" id="gas-url" placeholder="Google Apps Script„ÅÆURL„ÇíÂÖ•Âäõ">
                </div>
                <div class="input-group">
                    <label for="staff-select">„Çπ„Çø„ÉÉ„ÉïÂêç <span id="staff-label-suffix"></span></label>
                    <select id="staff-select" disabled>
                        <option value="">„Åæ„ÅöGAS URL„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                    </select>
                </div>
                <!-- VS Mode: Second Staff -->
                <div class="input-group" id="staff-b-group" style="display: none;">
                    <label for="staff-select-b">VS „Çπ„Çø„ÉÉ„ÉïÂêç</label>
                    <select id="staff-select-b" disabled>
                        <option value="">„Åæ„ÅöGAS URL„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                    </select>
                </div>
                <button class="btn" id="load-names-btn">ÂêçÂâç„ÇíË™≠Ëæº</button>
                <button class="btn" id="search-btn" disabled>„Éá„Éº„ÇøÂèñÂæó</button>
                <button class="btn" id="vs-compare-btn" disabled style="display: none; background: #ef4444;">‚öîÔ∏è
                    VSÊØîËºÉÂÆüË°å</button>
            </div>
            <p style="margin-top: 1rem; font-size: 0.85rem; color: var(--light-text-color);" id="mode-instruction">
                ‚Äª GAS URL„ÇíÂÖ•ÂäõÂæå„ÄåÂêçÂâç„ÇíË™≠Ëæº„Äç‚Üí „Çπ„Çø„ÉÉ„Éï„ÇíÈÅ∏Êäû ‚Üí„Äå„Éá„Éº„ÇøÂèñÂæó„Äç„ÅÆÈ†Ü„ÅßÊìç‰Ωú„Åó„Å¶„Åè„Å†„Åï„ÅÑ
            </p>
        </div>

        <!-- Results Section -->
        <div id="results-section">
            <div class="card" id="comparison-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 class="section-title" style="margin-bottom: 0; border-bottom: none;">
                        <span id="staff-name-display">„Çπ„Çø„ÉÉ„ÉïÂêç</span> „ÅÆÊàêÈï∑Êé®Áßª
                    </h3>
                    <button class="btn btn-success no-print" id="download-pdf-btn">PDF„Åß‰øùÂ≠ò</button>
                </div>

                <!-- Comparison Table -->
                <table class="comparison-table" id="comparison-table">
                    <thead>
                        <tr>
                            <th>È†ÖÁõÆ</th>
                            <!-- Dynamic headers will be inserted here -->
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dynamic rows will be inserted here -->
                    </tbody>
                </table>

                <!-- Skill Progress Bars -->
                <h4 style="font-family: 'Montserrat', sans-serif; margin-bottom: 1.5rem; color: var(--primary-color);">
                    üìä „Çπ„Ç≠„É´Ë©≥Á¥∞ÊØîËºÉ</h4>
                <div class="skills-container" id="skills-container">
                    <!-- Skills will be inserted here -->
                </div>

                <!-- Advice/Comment Box -->
                <div
                    style="margin-top: 2rem; padding: 1.5rem; background: #f8fafc; border-radius: 12px; border-left: 4px solid var(--secondary-color);">
                    <h4
                        style="font-family: 'Montserrat', sans-serif; margin-bottom: 1rem; color: var(--primary-color); font-size: 1rem;">
                        üí¨ „Ç≥„É°„É≥„Éà„Éª„Ç¢„Éâ„Éê„Ç§„Çπ
                    </h4>
                    <textarea id="advisor-comment"
                        style="width: 100%; min-height: 100px; padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px; font-family: inherit; font-size: 0.95rem; resize: vertical;"
                        placeholder="„Çπ„Çø„ÉÉ„Éï„Å∏„ÅÆ„Ç¢„Éâ„Éê„Ç§„Çπ„ÇÑË©ï‰æ°„Ç≥„É°„É≥„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ..."></textarea>
                </div>
            </div>
        </div>

        <footer>
            <p>SAPPORO VIEWTIFUL DINING ‚Äî ORIGIN</p>
            <p style="margin-top: 0.5rem;">¬© 2024-2025 SVD. All rights reserved.</p>
        </footer>
    </div>

    <script>
        // Configuration
        let GAS_URL = '';
        let chartInstances = [];

        // DOM Elements
        const gasUrlInput = document.getElementById('gas-url');
        const staffSelect = document.getElementById('staff-select');
        const staffSelectB = document.getElementById('staff-select-b');
        const staffBGroup = document.getElementById('staff-b-group');
        const loadNamesBtn = document.getElementById('load-names-btn');
        const searchBtn = document.getElementById('search-btn');
        const vsCompareBtn = document.getElementById('vs-compare-btn');
        const resultsSection = document.getElementById('results-section');
        const modeGrowthBtn = document.getElementById('mode-growth');
        const modeVsBtn = document.getElementById('mode-vs');
        const modeInstruction = document.getElementById('mode-instruction');

        // Current mode: 'growth' or 'vs'
        let currentMode = 'growth';

        // Mode switching
        modeGrowthBtn.addEventListener('click', () => {
            currentMode = 'growth';
            modeGrowthBtn.style.background = 'var(--primary-color)';
            modeVsBtn.style.background = '#64748b';
            staffBGroup.style.display = 'none';
            searchBtn.style.display = '';
            vsCompareBtn.style.display = 'none';
            modeInstruction.textContent = '‚Äª GAS URL„ÇíÂÖ•ÂäõÂæå„ÄåÂêçÂâç„ÇíË™≠Ëæº„Äç‚Üí „Çπ„Çø„ÉÉ„Éï„ÇíÈÅ∏Êäû ‚Üí„Äå„Éá„Éº„ÇøÂèñÂæó„Äç„ÅÆÈ†Ü„ÅßÊìç‰Ωú„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
        });

        modeVsBtn.addEventListener('click', () => {
            currentMode = 'vs';
            modeGrowthBtn.style.background = '#64748b';
            modeVsBtn.style.background = '#ef4444';
            staffBGroup.style.display = '';
            searchBtn.style.display = 'none';
            vsCompareBtn.style.display = '';
            modeInstruction.textContent = '‚Äª 2‰∫∫„ÅÆ„Çπ„Çø„ÉÉ„Éï„ÇíÈÅ∏Êäû„Åó„Å¶„ÄåVSÊØîËºÉÂÆüË°å„Äç„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
        });

        // Score categories for comparison
        const scoreCategories = [
            { key: 'TotalScore', label: 'Á∑èÂêà„Çπ„Ç≥„Ç¢' },
            { key: 'p', label: 'Performance Skills', items: ['p1', 'p2', 'p3', 'p4', 'p5', 'p6'] },
            { key: 's', label: 'Service Skills', items: ['s1', 's2', 's3', 's4', 's5', 's6'] },
            { key: 'e', label: 'Expertise Skills', items: ['e1', 'e2', 'e3', 'e4', 'e5', 'e6'] },
            { key: 'm', label: 'Management Skills', items: ['m1', 'm2', 'm3', 'm4', 'm5', 'm6'] }
        ];

        // Load staff names
        loadNamesBtn.addEventListener('click', async () => {
            GAS_URL = gasUrlInput.value.trim();
            if (!GAS_URL) {
                alert('GAS URL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            loadNamesBtn.textContent = 'Ë™≠Ëæº‰∏≠...';
            loadNamesBtn.disabled = true;

            try {
                const response = await fetch(`${GAS_URL}?action=list`, {
                    method: 'GET',
                    redirect: 'follow'
                });
                const text = await response.text();
                console.log('Response:', text);
                const data = JSON.parse(text);

                if (data.result === 'success' && data.names) {
                    // Update both dropdowns
                    const options = '<option value="">„Çπ„Çø„ÉÉ„Éï„ÇíÈÅ∏Êäû</option>' +
                        data.names.map(name => `<option value="${name}">${name}</option>`).join('');
                    staffSelect.innerHTML = options;
                    staffSelectB.innerHTML = options;

                    staffSelect.disabled = false;
                    staffSelectB.disabled = false;
                    searchBtn.disabled = false;
                    vsCompareBtn.disabled = false;
                    alert('„Çπ„Çø„ÉÉ„ÉïÂêç„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„ÅüÔºÅ (' + data.names.length + 'Âêç)');
                } else {
                    alert('„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + JSON.stringify(data));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message + '\n\nURL„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„Åæ„Åü„ÄÅGAS„Åå„Äå„Ç¶„Çß„Éñ„Ç¢„Éó„É™„Å®„Åó„Å¶„Éá„Éó„É≠„Ç§„Äç‚Üí„ÄåÂÖ®Âì°„Åå„Ç¢„ÇØ„Çª„ÇπÂèØËÉΩ„Äç„Å´Ë®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            } finally {
                loadNamesBtn.textContent = 'ÂêçÂâç„ÇíË™≠Ëæº';
                loadNamesBtn.disabled = false;
            }
        });

        // Search staff data
        searchBtn.addEventListener('click', async () => {
            const staffName = staffSelect.value;
            if (!staffName) {
                alert('„Çπ„Çø„ÉÉ„Éï„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            searchBtn.textContent = 'ÂèñÂæó‰∏≠...';
            searchBtn.disabled = true;

            try {
                const response = await fetch(`${GAS_URL}?action=search&name=${encodeURIComponent(staffName)}`);
                const data = await response.json();

                if (data.result === 'success' && data.data.length > 0) {
                    displayResults(staffName, data.data);
                } else {
                    alert('Ë©≤ÂΩì„Åô„Çã„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            } finally {
                searchBtn.textContent = '„Éá„Éº„ÇøÂèñÂæó';
                searchBtn.disabled = false;
            }
        });

        // VS Compare button handler
        vsCompareBtn.addEventListener('click', async () => {
            const staffNameA = staffSelect.value;
            const staffNameB = staffSelectB.value;

            if (!staffNameA || !staffNameB) {
                alert('2‰∫∫„ÅÆ„Çπ„Çø„ÉÉ„Éï„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            if (staffNameA === staffNameB) {
                alert('Áï∞„Å™„Çã„Çπ„Çø„ÉÉ„Éï„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            vsCompareBtn.textContent = 'ÊØîËºÉ‰∏≠...';
            vsCompareBtn.disabled = true;

            try {
                // Fetch both staff data
                const [responseA, responseB] = await Promise.all([
                    fetch(`${GAS_URL}?action=search&name=${encodeURIComponent(staffNameA)}`),
                    fetch(`${GAS_URL}?action=search&name=${encodeURIComponent(staffNameB)}`)
                ]);

                const dataA = await responseA.json();
                const dataB = await responseB.json();

                if (dataA.result === 'success' && dataA.data.length > 0 &&
                    dataB.result === 'success' && dataB.data.length > 0) {
                    // Get the latest record for each staff
                    const latestA = dataA.data[0];
                    const latestB = dataB.data[0];
                    displayVsResults(staffNameA, latestA, staffNameB, latestB);
                } else {
                    alert('Ë©≤ÂΩì„Åô„Çã„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            } finally {
                vsCompareBtn.textContent = '‚öîÔ∏è VSÊØîËºÉÂÆüË°å';
                vsCompareBtn.disabled = false;
            }
        });

        // Display results (Growth mode)
        function displayResults(staffName, records) {
            document.getElementById('staff-name-display').textContent = staffName;
            document.querySelector('#comparison-card > div:first-child > h3').innerHTML = `<span id="staff-name-display">${staffName}</span> „ÅÆÊàêÈï∑Êé®Áßª`;
            resultsSection.style.display = 'block';

            // Show comparison table (hidden in VS mode)
            document.getElementById('comparison-table').style.display = '';

            // Build comparison table
            buildComparisonTable(records);

            // Build charts
            buildCharts(records);
        }

        // Display VS Results
        function displayVsResults(nameA, recordA, nameB, recordB) {
            document.querySelector('#comparison-card > div:first-child > h3').innerHTML = `<span style="color: #3b82f6;">${nameA}</span> ‚öîÔ∏è <span style="color: #ef4444;">${nameB}</span>`;
            resultsSection.style.display = 'block';

            // Hide normal comparison table
            document.getElementById('comparison-table').style.display = 'none';

            // Build VS comparison
            buildVsComparison(nameA, recordA, nameB, recordB);
        }

        // Calculate category sum
        function calculateCategorySum(record, items) {
            return items.reduce((sum, key) => sum + (parseInt(record[key]) || 0), 0);
        }

        // Build comparison table
        function buildComparisonTable(records) {
            const table = document.getElementById('comparison-table');
            const thead = table.querySelector('thead tr');
            const tbody = table.querySelector('tbody');

            // Clear existing content
            thead.innerHTML = '<th>È†ÖÁõÆ</th>';
            tbody.innerHTML = '';

            // Add date headers
            records.forEach(record => {
                const date = new Date(record.Timestamp);
                const th = document.createElement('th');
                th.textContent = date.toLocaleDateString('ja-JP', { year: 'numeric', month: 'short', day: 'numeric' });
                thead.appendChild(th);
            });

            // Add growth column if more than 1 record
            if (records.length > 1) {
                const growthTh = document.createElement('th');
                growthTh.textContent = 'ÊàêÈï∑';
                growthTh.style.background = '#10b981';
                thead.appendChild(growthTh);
            }

            // Add rows
            scoreCategories.forEach(cat => {
                const tr = document.createElement('tr');
                const labelTd = document.createElement('td');
                labelTd.className = 'row-header';
                labelTd.textContent = cat.label;
                tr.appendChild(labelTd);

                const values = [];
                records.forEach(record => {
                    const td = document.createElement('td');
                    let value;
                    if (cat.key === 'TotalScore') {
                        value = parseFloat(record.TotalScore) || 0;
                        td.textContent = value.toFixed(2);
                    } else {
                        value = calculateCategorySum(record, cat.items);
                        td.textContent = value;
                    }
                    values.push(value);
                    tr.appendChild(td);
                });

                // Add growth cell
                if (records.length > 1) {
                    const growthTd = document.createElement('td');
                    const growth = values[0] - values[values.length - 1]; // newest - oldest
                    if (cat.key === 'TotalScore') {
                        growthTd.textContent = (growth >= 0 ? '+' : '') + growth.toFixed(2);
                    } else {
                        growthTd.textContent = (growth >= 0 ? '+' : '') + growth;
                    }
                    growthTd.className = growth >= 0 ? 'growth-positive' : 'growth-negative';
                    tr.appendChild(growthTd);
                }

                tbody.appendChild(tr);
            });
        }

        // Build skill progress bars
        function buildCharts(records) {
            const container = document.getElementById('skills-container');
            container.innerHTML = '';

            // Take up to 2 most recent records for comparison
            const compareRecords = records.slice(0, 2);
            const newest = compareRecords[0] || {};
            const oldest = compareRecords[1] || compareRecords[0] || {};

            // Get date labels
            const newestDate = newest.Timestamp ? new Date(newest.Timestamp).toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' }) : 'ÊúÄÊñ∞';
            const oldestDate = oldest.Timestamp && oldest !== newest ? new Date(oldest.Timestamp).toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' }) : 'ÂâçÂõû';

            // Total Score Card (prominent display) with formula breakdown
            const beforeTotal = parseFloat(oldest.TotalScore) || 0;
            const afterTotal = parseFloat(newest.TotalScore) || 0;
            const totalGrowth = afterTotal - beforeTotal;
            const totalGrowthClass = totalGrowth > 0 ? 'positive' : (totalGrowth < 0 ? 'negative' : 'neutral');
            const totalGrowthText = totalGrowth > 0 ? `+${totalGrowth.toFixed(2)}` : (totalGrowth < 0 ? totalGrowth.toFixed(2) : '¬±0');

            // Calculate category averages for formula display
            const calcAvg = (record, prefix) => {
                let sum = 0;
                for (let i = 1; i <= 6; i++) {
                    sum += parseInt(record[`${prefix}${i}`]) || 0;
                }
                return (sum / 6).toFixed(2);
            };

            const oldP = calcAvg(oldest, 'p'), oldS = calcAvg(oldest, 's'), oldE = calcAvg(oldest, 'e'), oldM = calcAvg(oldest, 'm');
            const newP = calcAvg(newest, 'p'), newS = calcAvg(newest, 's'), newE = calcAvg(newest, 'e'), newM = calcAvg(newest, 'm');
            const oldPS = (parseFloat(oldP) * parseFloat(oldS)).toFixed(2);
            const oldEM = (parseFloat(oldE) * parseFloat(oldM)).toFixed(2);
            const newPS = (parseFloat(newP) * parseFloat(newS)).toFixed(2);
            const newEM = (parseFloat(newE) * parseFloat(newM)).toFixed(2);

            const totalScoreCard = document.createElement('div');
            totalScoreCard.style.cssText = 'grid-column: 1 / -1; background: linear-gradient(135deg, #0f172a, #1e293b); color: white; padding: 2rem; border-radius: 16px; margin-bottom: 1rem;';
            totalScoreCard.innerHTML = `
                <div style="font-family: 'Montserrat', sans-serif; font-size: 0.9rem; color: #B8995C; letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 1rem; text-align: center;">Á∑èÂêà„Çπ„Ç≥„Ç¢</div>
                <div style="display: flex; justify-content: center; align-items: center; gap: 2rem; flex-wrap: wrap; margin-bottom: 1.5rem;">
                    <div style="text-align: center;">
                        <div style="font-size: 0.75rem; color: #94a3b8; margin-bottom: 0.3rem;">${oldestDate}</div>
                        <div style="font-family: 'Montserrat', sans-serif; font-size: 2.5rem; font-weight: 800; color: #94a3b8;">${beforeTotal.toFixed(2)}</div>
                    </div>
                    <div style="font-size: 2rem; color: #B8995C;">‚Üí</div>
                    <div style="text-align: center;">
                        <div style="font-size: 0.75rem; color: #B8995C; margin-bottom: 0.3rem;">${newestDate}</div>
                        <div style="font-family: 'Montserrat', sans-serif; font-size: 3.5rem; font-weight: 800; color: #D4AF37;">${afterTotal.toFixed(2)}</div>
                    </div>
                    <div style="background: ${totalGrowth >= 0 ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)'}; padding: 0.5rem 1rem; border-radius: 8px;">
                        <div style="font-size: 0.7rem; color: ${totalGrowth >= 0 ? '#10b981' : '#ef4444'}; margin-bottom: 0.2rem;">ÊàêÈï∑</div>
                        <div style="font-family: 'Montserrat', sans-serif; font-size: 1.5rem; font-weight: 700; color: ${totalGrowth >= 0 ? '#10b981' : '#ef4444'};">${totalGrowthText}</div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; font-size: 0.8rem;">
                    <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 8px;">
                        <div style="color: #94a3b8; margin-bottom: 0.5rem; font-weight: 600;">${oldestDate} „ÅÆË®àÁÆóÂºè</div>
                        <div style="color: #64748b; margin-bottom: 0.3rem;"><span style="color: #f59e0b;">„Ç≤„Çπ„Éà„Ç®„ÇØ„Çπ„Éö„É™„Ç®„É≥„Çπ</span> P√óS = ${oldPS}</div>
                        <div style="color: #64748b; margin-bottom: 0.3rem;"><span style="color: #8b5cf6;">„ÉÅ„Éº„É†„Éâ„É™„Éñ„É≥</span> E√óM = ${oldEM}</div>
                        <div style="color: #94a3b8; font-weight: 600; margin-top: 0.5rem;">${oldPS} + ${oldEM} = ${beforeTotal.toFixed(2)}</div>
                    </div>
                    <div style="background: rgba(184, 153, 92, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid rgba(184, 153, 92, 0.3);">
                        <div style="color: #B8995C; margin-bottom: 0.5rem; font-weight: 600;">${newestDate} „ÅÆË®àÁÆóÂºè</div>
                        <div style="color: #94a3b8; margin-bottom: 0.3rem;"><span style="color: #f59e0b;">„Ç≤„Çπ„Éà„Ç®„ÇØ„Çπ„Éö„É™„Ç®„É≥„Çπ</span> P√óS = ${newPS}</div>
                        <div style="color: #94a3b8; margin-bottom: 0.3rem;"><span style="color: #8b5cf6;">„ÉÅ„Éº„É†„Éâ„É™„Éñ„É≥</span> E√óM = ${newEM}</div>
                        <div style="color: #D4AF37; font-weight: 600; margin-top: 0.5rem;">${newPS} + ${newEM} = ${afterTotal.toFixed(2)}</div>
                    </div>
                </div>
            `;
            container.appendChild(totalScoreCard);

            // Skill definitions with Japanese labels
            const skillCategories = [
                {
                    key: 'p',
                    title: 'Performance',
                    subtitle: 'ÂÆüË°åÂäõ',
                    color: '#f59e0b',
                    skills: [
                        { id: 'p1', name: 'P1', label: 'Ê¥ªÊ∞ó' },
                        { id: 'p2', name: 'P2', label: 'ËøÖÈÄü' },
                        { id: 'p3', name: 'P3', label: 'ÈÄ£Êê∫' },
                        { id: 'p4', name: 'P4', label: 'Ê≠£Á¢∫' },
                        { id: 'p5', name: 'P5', label: 'ÊüîËªü' },
                        { id: 'p6', name: 'P6', label: 'Âà§Êñ≠' }
                    ]
                },
                {
                    key: 's',
                    title: 'Service',
                    subtitle: 'Êé•ÂÆ¢Âäõ',
                    color: '#10b981',
                    skills: [
                        { id: 's1', name: 'S1', label: 'Á¨ëÈ°î' },
                        { id: 's2', name: 'S2', label: 'ÂÇæËÅ¥' },
                        { id: 's3', name: 'S3', label: 'ÊèêÊ°à' },
                        { id: 's4', name: 'S4', label: 'ÈÖçÊÖÆ' },
                        { id: 's5', name: 'S5', label: 'Ë®òÊÜ∂' },
                        { id: 's6', name: 'S6', label: 'ÊºîÂá∫' }
                    ]
                },
                {
                    key: 'e',
                    title: 'Expertise',
                    subtitle: 'Â∞ÇÈñÄÊÄß',
                    color: '#3b82f6',
                    skills: [
                        { id: 'e1', name: 'E1', label: 'ÂïÜÂìÅÁü•Ë≠ò' },
                        { id: 'e2', name: 'E2', label: 'ÊäÄË°ì' },
                        { id: 'e3', name: 'E3', label: 'Ë°õÁîü' },
                        { id: 'e4', name: 'E4', label: 'ÂäπÁéá' },
                        { id: 'e5', name: 'E5', label: 'ÊîπÂñÑ' },
                        { id: 'e6', name: 'E6', label: 'Â≠¶Áøí' }
                    ]
                },
                {
                    key: 'm',
                    title: 'Management',
                    subtitle: 'ÁÆ°ÁêÜÂäõ',
                    color: '#8b5cf6',
                    skills: [
                        { id: 'm1', name: 'M1', label: 'Ë®àÁîª' },
                        { id: 'm2', name: 'M2', label: 'ÊåáÂ∞é' },
                        { id: 'm3', name: 'M3', label: 'Ë™øÊï¥' },
                        { id: 'm4', name: 'M4', label: 'ÂàÜÊûê' },
                        { id: 'm5', name: 'M5', label: 'Ê±∫Êñ≠' },
                        { id: 'm6', name: 'M6', label: 'Ë≤¨‰ªª' }
                    ]
                }
            ];

            skillCategories.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'skill-category';
                categoryDiv.style.borderLeftColor = category.color;

                categoryDiv.innerHTML = `
                    <div class="skill-category-title">
                        <span style="color: ${category.color};">${category.title}</span>
                        <span style="font-weight: 400; color: var(--light-text-color);">${category.subtitle}</span>
                    </div>
                `;

                category.skills.forEach(skill => {
                    const beforeVal = parseInt(oldest[skill.id]) || 0;
                    const afterVal = parseInt(newest[skill.id]) || 0;
                    const growth = afterVal - beforeVal;
                    const growthClass = growth > 0 ? 'positive' : (growth < 0 ? 'negative' : 'neutral');
                    const growthText = growth > 0 ? `+${growth}` : (growth < 0 ? growth : '¬±0');

                    const skillDiv = document.createElement('div');
                    skillDiv.className = 'skill-item';
                    skillDiv.innerHTML = `
                        <div class="skill-label">
                            <span class="skill-name">${skill.name} <span>${skill.label}</span></span>
                            <span class="growth-badge ${growthClass}">${growthText}</span>
                        </div>
                        <div class="skill-bars">
                            <div class="bar-row">
                                <span class="bar-label">${oldestDate}</span>
                                <div class="bar-track">
                                    <div class="bar-fill-before" style="width: ${(beforeVal / 10) * 100}%;"></div>
                                </div>
                                <span style="font-size: 0.7rem; font-weight: 600; width: 20px; text-align: right;">${beforeVal}</span>
                            </div>
                            <div class="bar-row">
                                <span class="bar-label">${newestDate}</span>
                                <div class="bar-track">
                                    <div class="bar-fill-after" style="width: ${(afterVal / 10) * 100}%;"></div>
                                </div>
                                <span style="font-size: 0.7rem; font-weight: 600; width: 20px; text-align: right; color: ${category.color};">${afterVal}</span>
                            </div>
                        </div>
                    `;
                    categoryDiv.appendChild(skillDiv);
                });

                container.appendChild(categoryDiv);
            });
        }

        // Build VS Comparison view
        function buildVsComparison(nameA, recordA, nameB, recordB) {
            const container = document.getElementById('skills-container');
            container.innerHTML = '';

            // Calculate scores
            const calcAvg = (record, prefix) => {
                let sum = 0;
                for (let i = 1; i <= 6; i++) {
                    sum += parseInt(record[`${prefix}${i}`]) || 0;
                }
                return sum / 6;
            };

            const totalA = parseFloat(recordA.TotalScore) || 0;
            const totalB = parseFloat(recordB.TotalScore) || 0;
            const pA = calcAvg(recordA, 'p'), sA = calcAvg(recordA, 's'), eA = calcAvg(recordA, 'e'), mA = calcAvg(recordA, 'm');
            const pB = calcAvg(recordB, 'p'), sB = calcAvg(recordB, 's'), eB = calcAvg(recordB, 'e'), mB = calcAvg(recordB, 'm');
            const guestExpA = pA * sA, teamDrivenA = eA * mA;
            const guestExpB = pB * sB, teamDrivenB = eB * mB;

            // Format dates
            const dateA = recordA.Timestamp ? new Date(recordA.Timestamp).toLocaleDateString('ja-JP', { year: 'numeric', month: 'short', day: 'numeric' }) : 'Êó•‰ªò‰∏çÊòé';
            const dateB = recordB.Timestamp ? new Date(recordB.Timestamp).toLocaleDateString('ja-JP', { year: 'numeric', month: 'short', day: 'numeric' }) : 'Êó•‰ªò‰∏çÊòé';

            // VS Header Card
            const vsCard = document.createElement('div');
            vsCard.style.cssText = 'grid-column: 1 / -1; background: linear-gradient(135deg, #0f172a, #1e293b); color: white; padding: 2rem; border-radius: 16px; margin-bottom: 1rem;';
            vsCard.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 1.5rem; align-items: center;">
                    <div style="text-align: center;">
                        <div style="font-size: 1.2rem; color: #3b82f6; font-weight: 700;">${nameA}</div>
                        <div style="font-size: 0.75rem; color: #94a3b8; margin-bottom: 0.5rem;">üìÖ ${dateA}</div>
                        <div style="font-family: 'Montserrat', sans-serif; font-size: 3.5rem; font-weight: 800; color: ${totalA > totalB ? '#D4AF37' : '#94a3b8'};">${totalA.toFixed(2)}</div>
                        <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="font-size: 0.75rem; color: #f59e0b; font-weight: 600;">„Ç≤„Çπ„Éà„Ç®„ÇØ„Çπ„Éö„É™„Ç®„É≥„Çπ</span>
                                <span style="font-family: 'Montserrat', sans-serif; font-size: 1.1rem; font-weight: 700; color: #f59e0b;">${guestExpA.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 0.75rem; color: #8b5cf6; font-weight: 600;">„ÉÅ„Éº„É†„Éâ„É™„Éñ„É≥</span>
                                <span style="font-family: 'Montserrat', sans-serif; font-size: 1.1rem; font-weight: 700; color: #8b5cf6;">${teamDrivenA.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 3.5rem; color: #ef4444;">‚öîÔ∏è</div>
                        <div style="font-size: 0.9rem; color: #64748b; margin-top: 0.5rem; font-weight: 600;">VS</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.2rem; color: #ef4444; font-weight: 700;">${nameB}</div>
                        <div style="font-size: 0.75rem; color: #94a3b8; margin-bottom: 0.5rem;">üìÖ ${dateB}</div>
                        <div style="font-family: 'Montserrat', sans-serif; font-size: 3.5rem; font-weight: 800; color: ${totalB > totalA ? '#D4AF37' : '#94a3b8'};">${totalB.toFixed(2)}</div>
                        <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="font-size: 0.75rem; color: #f59e0b; font-weight: 600;">„Ç≤„Çπ„Éà„Ç®„ÇØ„Çπ„Éö„É™„Ç®„É≥„Çπ</span>
                                <span style="font-family: 'Montserrat', sans-serif; font-size: 1.1rem; font-weight: 700; color: #f59e0b;">${guestExpB.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 0.75rem; color: #8b5cf6; font-weight: 600;">„ÉÅ„Éº„É†„Éâ„É™„Éñ„É≥</span>
                                <span style="font-family: 'Montserrat', sans-serif; font-size: 1.1rem; font-weight: 700; color: #8b5cf6;">${teamDrivenB.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                </div>
                ${totalA !== totalB ? `<div style="text-align: center; margin-top: 1.5rem; font-size: 1rem; color: #10b981; font-weight: 600;">üèÜ ${totalA > totalB ? nameA : nameB} „Åå ${Math.abs(totalA - totalB).toFixed(2)} ÁÇπ„É™„Éº„Éâ</div>` : ''}
            `;
            container.appendChild(vsCard);

            // Skill categories for VS comparison
            const skillCategories = [
                { key: 'p', title: 'Performance', subtitle: 'ÂÆüË°åÂäõ', color: '#f59e0b', skills: ['p1', 'p2', 'p3', 'p4', 'p5', 'p6'], labels: ['Ê¥ªÊ∞ó', 'ËøÖÈÄü', 'ÈÄ£Êê∫', 'Ê≠£Á¢∫', 'ÊüîËªü', 'Âà§Êñ≠'] },
                { key: 's', title: 'Service', subtitle: 'Êé•ÂÆ¢Âäõ', color: '#10b981', skills: ['s1', 's2', 's3', 's4', 's5', 's6'], labels: ['Á¨ëÈ°î', 'ÂÇæËÅ¥', 'ÊèêÊ°à', 'ÈÖçÊÖÆ', 'Ë®òÊÜ∂', 'ÊºîÂá∫'] },
                { key: 'e', title: 'Expertise', subtitle: 'Â∞ÇÈñÄÊÄß', color: '#3b82f6', skills: ['e1', 'e2', 'e3', 'e4', 'e5', 'e6'], labels: ['ÂïÜÂìÅÁü•Ë≠ò', 'ÊäÄË°ì', 'Ë°õÁîü', 'ÂäπÁéá', 'ÊîπÂñÑ', 'Â≠¶Áøí'] },
                { key: 'm', title: 'Management', subtitle: 'ÁÆ°ÁêÜÂäõ', color: '#8b5cf6', skills: ['m1', 'm2', 'm3', 'm4', 'm5', 'm6'], labels: ['Ë®àÁîª', 'ÊåáÂ∞é', 'Ë™øÊï¥', 'ÂàÜÊûê', 'Ê±∫Êñ≠', 'Ë≤¨‰ªª'] }
            ];

            skillCategories.forEach(cat => {
                const categoryCard = document.createElement('div');
                categoryCard.className = 'skill-category';
                categoryCard.style.borderLeftColor = cat.color;

                let skillsHtml = '';
                cat.skills.forEach((skillId, idx) => {
                    const valA = parseInt(recordA[skillId]) || 0;
                    const valB = parseInt(recordB[skillId]) || 0;
                    const winner = valA > valB ? 'A' : (valB > valA ? 'B' : '');

                    skillsHtml += `
                        <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem; padding: 0.3rem 0; ${idx < cat.skills.length - 1 ? 'border-bottom: 1px solid #e2e8f0;' : ''}">
                            <div style="display: flex; align-items: center; gap: 0.3rem;">
                                <div style="width: 60%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                                    <div style="width: ${(valA / 10) * 100}%; height: 100%; background: ${winner === 'A' ? '#3b82f6' : '#94a3b8'}; border-radius: 4px;"></div>
                                </div>
                                <span style="font-weight: 600; color: ${winner === 'A' ? '#3b82f6' : '#64748b'}; min-width: 20px;">${valA}</span>
                            </div>
                            <div style="text-align: center; font-size: 0.75rem; color: ${cat.color}; font-weight: 600;">
                                ${cat.skills[idx].toUpperCase()}<br><span style="font-weight: 400; color: #64748b;">${cat.labels[idx]}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.3rem; justify-content: flex-end;">
                                <span style="font-weight: 600; color: ${winner === 'B' ? '#ef4444' : '#64748b'}; min-width: 20px;">${valB}</span>
                                <div style="width: 60%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                                    <div style="width: ${(valB / 10) * 100}%; height: 100%; background: ${winner === 'B' ? '#ef4444' : '#94a3b8'}; border-radius: 4px;"></div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                categoryCard.innerHTML = `
                    <div class="skill-category-title">
                        <span style="color: ${cat.color};">${cat.title}</span>
                        <span style="font-weight: 400; color: var(--light-text-color);">${cat.subtitle}</span>
                    </div>
                    ${skillsHtml}
                `;
                container.appendChild(categoryCard);
            });
        }

        // PDF Download
        document.getElementById('download-pdf-btn').addEventListener('click', async () => {
            const btn = document.getElementById('download-pdf-btn');
            btn.textContent = 'ÁîüÊàê‰∏≠...';
            btn.disabled = true;

            try {
                const element = document.getElementById('comparison-card');

                // Convert textarea to div for PDF
                const textarea = document.getElementById('advisor-comment');
                const commentText = textarea.value;
                const commentDiv = document.createElement('div');
                commentDiv.id = 'comment-for-pdf';
                commentDiv.style.cssText = 'width: 100%; min-height: 60px; padding: 1rem; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.95rem; white-space: pre-wrap; background: white;';
                commentDiv.textContent = commentText || 'Ôºà„Ç≥„É°„É≥„Éà„Å™„ÅóÔºâ';
                textarea.style.display = 'none';
                textarea.parentNode.insertBefore(commentDiv, textarea.nextSibling);

                const canvas = await html2canvas(element, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff'
                });

                // Restore textarea
                textarea.style.display = '';
                commentDiv.remove();

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('l', 'mm', 'a4'); // Landscape

                const imgWidth = 287;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;

                // Handle multi-page if content is too tall
                const pageHeight = 200;
                if (imgHeight > pageHeight) {
                    let position = 0;
                    let remainingHeight = imgHeight;
                    while (remainingHeight > 0) {
                        pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 5, 5 - position, imgWidth, imgHeight);
                        remainingHeight -= pageHeight;
                        if (remainingHeight > 0) {
                            pdf.addPage();
                            position += pageHeight;
                        }
                    }
                } else {
                    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 5, 5, imgWidth, imgHeight);
                }

                // Get filename based on mode
                let filename;
                const titleEl = document.querySelector('#comparison-card > div:first-child > h3');
                if (currentMode === 'vs') {
                    const nameA = staffSelect.value || 'StaffA';
                    const nameB = staffSelectB.value || 'StaffB';
                    filename = `SVD_VS_${nameA}_vs_${nameB}`;
                } else {
                    const staffName = staffSelect.value || 'Staff';
                    filename = `SVD_Growth_${staffName}`;
                }
                const date = new Date().toISOString().split('T')[0];
                pdf.save(`${filename}_${date}.pdf`);
            } catch (error) {
                console.error('PDF Error:', error);
                alert('PDFÁîüÊàê‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
            } finally {
                btn.textContent = 'PDF„Åß‰øùÂ≠ò';
                btn.disabled = false;
            }
        });
    </script>
</body>

</html>