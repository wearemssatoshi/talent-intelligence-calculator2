<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVD Manager Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <!-- Replaced html2pdf with specific libraries for better control -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Montserrat:wght@300;400;500;600;700;800;900&display=swap');

        :root {
            --primary-color: #0f172a;
            --secondary-color: #B8995C;
            --accent-color: #D4AF37;
            --background-color: #f8fafc;
            --text-color: #1e293b;
            --light-text-color: #64748b;
            --border-color: #e2e8f0;
            --card-bg: #FFFFFF;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 2rem;
            line-height: 1.7;
        }

        /* --- SNAPSHOT CAPTURE STYLES --- */
        /* These styles ensure the element looks good when captured by html2canvas */
        #team-simulator {
            background: #E3F2FD;
            border: 2px solid #2196F3;
        }

        /* PDF Optimization: Beautiful 2-Tier Layout */
        #team-simulator.pdf-mode {
            padding: 1.5rem !important;
        }

        /* Title area - centered and prominent */
        #team-simulator.pdf-mode>div:first-child {
            text-align: center;
            margin-bottom: 1rem !important;
        }

        /* Main heading - compact */
        #team-simulator.pdf-mode>h2 {
            font-size: 2rem !important;
            margin: 0.5rem 0 1rem 0 !important;
        }

        /* TIER 1: Metrics and Chart - horizontal layout */
        #team-simulator.pdf-mode>div:last-child {
            display: grid !important;
            grid-template-columns: 2fr 1fr !important;
            grid-template-rows: auto auto !important;
            gap: 1.5rem !important;
            margin-bottom: 1.5rem !important;
        }

        /* Member list - spans full width at bottom */
        #team-simulator.pdf-mode>div:last-child>div:first-child {
            grid-column: 1 / -1 !important;
            grid-row: 2 !important;
        }

        /* Metrics - left side of top row */
        #team-simulator.pdf-mode>div:last-child>div:nth-child(2) {
            grid-column: 1 !important;
            grid-row: 1 !important;
        }

        /* Chart - right side of top row */
        #team-simulator.pdf-mode>div:last-child>div:nth-child(3) {
            grid-column: 2 !important;
            grid-row: 1 !important;
        }

        /* Member list - 3 column grid */
        #team-simulator.pdf-mode #team-list {
            display: grid !important;
            grid-template-columns: repeat(3, 1fr) !important;
            gap: 0.4rem !important;
            padding: 0 !important;
            margin: 0 !important;
        }

        #team-simulator.pdf-mode #team-list li {
            padding: 0.3rem 0.5rem !important;
            margin: 0 !important;
            font-size: 0.75rem !important;
            line-height: 1.3 !important;
        }

        /* Compact headings */
        #team-simulator.pdf-mode h3 {
            font-size: 1.1rem !important;
            margin: 0 0 0.5rem 0 !important;
        }

        /* Compact metrics */
        #team-simulator.pdf-mode #team-momentum-score,
        #team-simulator.pdf-mode #total-power-score {
            font-size: 3rem !important;
            line-height: 1 !important;
        }

        /* Compact advice section */
        #team-simulator.pdf-mode #team-advice {
            font-size: 0.75rem !important;
            padding: 0.5rem !important;
            line-height: 1.4 !important;
        }

        /* Chart sizing */
        #team-simulator.pdf-mode #chart-container {
            max-height: 180px !important;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem 0;
        }

        .header-logo {
            width: 180px;
            height: auto;
            margin-bottom: 1.5rem;
            opacity: 0.9;
        }

        header h1 {
            font-family: 'Montserrat', sans-serif;
            color: var(--primary-color);
            font-weight: 800;
            font-size: 2.2rem;
            margin: 0;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        header p {
            color: var(--secondary-color);
            margin-top: 0.5rem;
            font-size: 0.9rem;
            font-weight: 500;
            letter-spacing: 0.15em;
            text-transform: uppercase;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 1rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            font-family: 'Montserrat', sans-serif;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-accent {
            background: var(--secondary-color);
            box-shadow: 0 4px 15px rgba(184, 153, 92, 0.4);
        }

        .btn-accent:hover {
            background: var(--accent-color);
            box-shadow: 0 6px 20px rgba(184, 153, 92, 0.5);
        }

        /* Member List Styles */
        #member-selection-area {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .member-card {
            background: #fff;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .member-card:hover {
            border-color: var(--secondary-color);
            background: #f5f7fa;
        }

        .member-card.selected {
            background: #E3F2FD;
            border-color: #2196F3;
        }

        .member-info h4 {
            margin: 0 0 0.2rem 0;
            color: var(--primary-color);
        }

        .member-info p {
            margin: 0;
            font-size: 0.9rem;
            color: var(--light-text-color);
        }

        /* Team Simulator Styles (Copied) */
        #team-simulator {
            background: #E3F2FD;
            border: 2px solid #2196F3;
        }

        #team-momentum-score {
            font-family: 'Montserrat', sans-serif;
            font-size: 5rem;
            font-weight: 800;
            color: var(--secondary-color);
            line-height: 1;
        }

        body.printing-mode>* {
            display: none !important;
        }

        body.printing-mode>#team-simulator {
            display: block !important;
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            max-width: 1120px !important;
            /* A4 Landscape width approx */
            margin: 0 !important;
            padding: 20px !important;
            box-shadow: none !important;
            border: none !important;
            z-index: 99999 !important;
            background: white !important;
        }

        /* --------------------------- */

        /* Mobile Optimization */
        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }

            .container {
                padding: 0;
            }

            header h1 {
                font-size: 2.5rem;
            }

            .card {
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }

            input[type="text"],
            select {
                font-size: 16px;
                /* Prevent zoom on iOS */
                padding: 12px;
            }

            .btn {
                width: 100%;
                padding: 1rem;
                font-size: 1rem;
            }

            #team-simulator h2 {
                font-size: 1.8rem !important;
            }

            #team-simulator h3 {
                font-size: 1rem !important;
            }

            .team-metrics-grid {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }

            #team-list {
                grid-template-columns: 1fr !important;
            }

            .metric-value {
                font-size: 2.5rem !important;
            }

            #member-selection-area {
                grid-template-columns: 1fr !important;
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <img src="../logo/SVD_logo_Black.png" alt="SVD Logo" class="header-logo">
            <h1>Manager Dashboard</h1>
            <p>Team Analysis & Momentum Simulator</p>
        </header>

        <!-- Data Loading Section -->
        <div class="card" data-html2canvas-ignore="true">
            <h2>1. Load Staff Data</h2>
            <p>Google Sheetsから最新のスタッフデータを読み込みます。</p>
            <div style="display: flex; gap: 1rem; align-items: center;">
                <input type="text" id="script-url" placeholder="Enter Google Apps Script Web App URL"
                    value="https://script.google.com/macros/s/AKfycbylwBwxUjqQlrolic8ISUJBU84_uWEeoz9C4YL3UHrmZz_EBzOQvR20pEgwLGmrtjxg/exec"
                    style="flex: 1; padding: 0.8rem; border: 1px solid var(--border-color); border-radius: 6px;">
                <button id="load-data-btn" class="btn">Load Data</button>
            </div>
            <p id="loading-status" style="margin-top: 0.5rem; color: var(--light-text-color);"></p>
        </div>

        <!-- Member Selection Section -->
        <div class="card" id="selection-card" style="display: none;" data-html2canvas-ignore="true">
            <h2>2. Select Team Members</h2>
            <p>分析したいメンバーをクリックして選択してください。</p>
            <div id="member-selection-area">
                <!-- Members will be populated here -->
            </div>
        </div>

        <!-- Team Simulator Section -->
        <div class="card" id="team-simulator" style="display:none;">
            <div
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                <!-- Print Title (Hidden by default, shown in print) -->
                <div id="team-name-print-display" style="display:none;"></div>

                <input type="text" id="team-name-input" placeholder="チーム名を入力（例: JEWELS Aチーム）"
                    style="font-family: 'Montserrat', sans-serif; font-size: 1.5rem; font-weight: 700; color: #0f172a; border: none; background: transparent; border-bottom: 2px solid #B8995C; flex: 1; min-width: 200px;">
                <button onclick="exportPDF()" class="btn btn-accent" data-html2canvas-ignore="true">PDF保存</button>
            </div>

            <h2
                style="text-align: center; color: var(--secondary-color); font-family: 'Montserrat', sans-serif; font-size: 2rem; font-weight: 800; margin-top: 0; letter-spacing: 0.1em;">
                TEAM MOMENTUM SIMULATOR
            </h2>

            <!-- NEW 2-TIER LAYOUT -->
            <div class="team-metrics-grid"
                style="display: grid; grid-template-columns: 2fr 1fr; grid-template-rows: auto auto; gap: 2rem; margin-bottom: 2rem;">
                <!-- TIER 1 LEFT: Metrics -->
                <div style="text-align: center;">
                    <h3
                        style="font-family: 'Montserrat', sans-serif; font-weight: 700; color: var(--primary-color); letter-spacing: 0.05em;">
                        TEAM MOMENTUM METRICS</h3>
                    <div
                        style="display: flex; justify-content: space-around; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                        <div>
                            <div style="font-size: 0.85rem; color: var(--light-text-color); font-weight: 500;">Quality
                                (Avg)</div>
                            <div id="team-momentum-score" class="metric-value"
                                style="font-family: 'Montserrat', sans-serif; font-size: 3.5rem; font-weight: 800; color: var(--secondary-color); line-height: 1;">
                                0</div>
                        </div>
                        <div>
                            <div style="font-size: 0.85rem; color: var(--light-text-color); font-weight: 500;">Total
                                Momentum</div>
                            <div id="total-power-score" class="metric-value"
                                style="font-family: 'Montserrat', sans-serif; font-size: 3.5rem; font-weight: 800; color: var(--primary-color); line-height: 1;">
                                0</div>
                        </div>
                    </div>
                    <p id="synergy-bonus" style="color: var(--secondary-color); font-weight: 600; font-size: 0.95rem;">
                    </p>
                    <div id="team-advice"
                        style="background: var(--background-color); padding: 1rem; border-radius: 8px; margin-top: 1rem; text-align: left; border-left: 4px solid var(--secondary-color);">
                        <strong style="color: var(--primary-color);">チーム分析:</strong><br>
                        メンバーを追加して分析を開始してください。
                    </div>
                </div>

                <!-- TIER 1 RIGHT: Chart -->
                <div>
                    <h3
                        style="text-align: center; font-family: 'Montserrat', sans-serif; font-weight: 700; color: var(--primary-color);">
                        Team Skill Balance</h3>
                    <div id="chart-container">
                        <canvas id="team-radar-chart"></canvas>
                    </div>
                </div>

                <!-- TIER 2: Member List (spans full width) -->
                <div style="grid-column: 1 / -1;">
                    <h3 style="font-family: 'Montserrat', sans-serif; font-weight: 700; color: var(--primary-color);">
                        Selected Members</h3>
                    <ul id="team-list"
                        style="list-style: none; padding: 0; display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                        <!-- Team members will be added here -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer
            style="text-align: center; margin-top: 4rem; padding: 2rem 0; border-top: 1px solid var(--border-color);">
            <p
                style="font-family: 'Montserrat', sans-serif; font-size: 0.8rem; color: var(--light-text-color); letter-spacing: 0.15em; text-transform: uppercase; margin: 0;">
                SAPPORO VIEWTIFUL DINING — ORIGIN
            </p>
            <p style="font-size: 0.75rem; color: var(--light-text-color); margin: 0.5rem 0 0 0;">
                © 2024-2025 SVD. All rights reserved.
            </p>
        </footer>

    </div>

    <script>
        // --- SVD 18 TYPES DATA ---
        const svdTypes = {
            "Balance": { name: "Balance (バランス)", desc: "汎用・適応" },
            "Flare": { name: "Flare (フレア)", desc: "情熱・突破" },
            "Flow": { name: "Flow (フロー)", desc: "柔軟・浸透" },
            "Bloom": { name: "Bloom (ブルーム)", desc: "育成・調和" },
            "Spark": { name: "Spark (スパーク)", desc: "閃き・革新" },
            "Crystal": { name: "Crystal (クリスタル)", desc: "緻密・冷静" },
            "Striker": { name: "Striker (ストライカー)", desc: "実直・技術" },
            "Rogue": { name: "Rogue (ローグ)", desc: "改革・本質" },
            "Ground": { name: "Ground (グラウンド)", desc: "安定・土台" },
            "Wing": { name: "Wing (ウィング)", desc: "自由・俯瞰" },
            "Seraph": { name: "Seraph (セラフ)", desc: "洞察・予知" },
            "Craft": { name: "Craft (クラフト)", desc: "改善・適応" },
            "Solid": { name: "Solid (ソリッド)", desc: "信念・伝統" },
            "Shade": { name: "Shade (シェード)", desc: "献身・黒子" },
            "Emperor": { name: "Emperor (エンペラー)", desc: "統率・圧倒" },
            "Night Shift": { name: "Night Shift (ナイトシフト)", desc: "危機・実利" },
            "Iron": { name: "Iron (アイアン)", desc: "鉄壁・規律" },
            "Bliss": { name: "Bliss (ブリス)", desc: "愛嬌・浄化" }
        };

        // Synergy Data (Best Match & Caution Match)
        const synergyData = {
            "Balance": { best: ["Flare", "Emperor"], caution: [] },
            "Flare": { best: ["Flow", "Ground"], caution: ["Flare"] },
            "Flow": { best: ["Flare", "Spark"], caution: ["Solid"] },
            "Bloom": { best: ["Flare", "Ground"], caution: ["Rogue", "Night Shift"] },
            "Spark": { best: ["Flow", "Wing"], caution: ["Ground"] },
            "Crystal": { best: ["Flare", "Striker"], caution: ["Spark"] },
            "Striker": { best: ["Seraph", "Bloom"], caution: ["Wing"] },
            "Rogue": { best: ["Seraph", "Ground"], caution: ["Bloom", "Bliss"] },
            "Ground": { best: ["Spark", "Flare"], caution: ["Flow", "Wing"] },
            "Wing": { best: ["Spark", "Ground"], caution: ["Striker", "Iron"] },
            "Seraph": { best: ["Striker", "Rogue"], caution: ["Night Shift", "Craft"] },
            "Craft": { best: ["Bloom", "Iron"], caution: ["Flare", "Wing"] },
            "Solid": { best: ["Striker", "Ground"], caution: ["Flow", "Spark"] },
            "Shade": { best: ["Emperor", "Seraph"], caution: ["Night Shift"] },
            "Emperor": { best: ["Bliss", "Shade"], caution: ["Bliss", "Crystal"] },
            "Night Shift": { best: ["Rogue", "Striker"], caution: ["Bloom", "Bliss"] },
            "Iron": { best: ["Crystal", "Striker"], caution: ["Flare", "Rogue"] },
            "Bliss": { best: ["Emperor", "Iron"], caution: ["Rogue", "Night Shift"] }
        };

        // --- APP LOGIC ---
        let allStaffData = [];
        let teamMembers = [];
        let teamRadarChart = null;

        document.getElementById('load-data-btn').addEventListener('click', loadData);

        function loadData() {
            const scriptUrl = document.getElementById('script-url').value;
            const statusEl = document.getElementById('loading-status');

            if (!scriptUrl) {
                alert('Please enter the Script URL.');
                return;
            }

            statusEl.textContent = 'Loading data...';

            // Append ?action=getStaffData to the URL to trigger the doGet logic
            fetch(`${scriptUrl}?action=getStaffData`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        allStaffData = data.data;
                        statusEl.textContent = `Successfully loaded ${allStaffData.length} staff members.`;
                        renderMemberSelection();
                        document.getElementById('selection-card').style.display = 'block';
                        document.getElementById('team-simulator').style.display = 'block';
                    } else {
                        throw new Error(data.message || 'Unknown error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    statusEl.textContent = 'Error loading data. Please check the URL and try again. (Make sure the script is deployed as "Anyone")';
                    // For demo purposes, let's load some dummy data if fetch fails
                    if (confirm("データの読み込みに失敗しました。ダミーデータでテストしますか？")) {
                        loadDummyData();
                    }
                });
        }

        function loadDummyData() {
            allStaffData = [
                { name: "Sato (Demo)", affiliation: "JEWELS", jobTitle: "マネジャー", type: "Flare", score: 8.5, meisterRank: "Expert", qualifications: "J.S.A. ソムリエ", detailedScores: [5, 5, 5, 5, 5, 5, 4, 4, 4, 4, 4, 4, 3, 3, 3, 3, 3, 3, 2, 2, 2, 2, 2, 2] },
                { name: "Suzuki (Demo)", affiliation: "GARDEN", jobTitle: "キャプテン", type: "Flow", score: 7.8, meisterRank: "Specialist", qualifications: "食品衛生責任者", detailedScores: [4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 3, 3, 3, 3, 3, 3, 2, 2, 2, 2, 2, 2] },
                { name: "Tanaka (Demo)", affiliation: "BRIQUE", jobTitle: "一般", type: "Ground", score: 9.0, meisterRank: "Master", qualifications: "HRS 1級, ソムリエ・エクセレンス", detailedScores: [5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 4, 4, 4, 4, 4, 4] }
            ];
            renderMemberSelection();
            document.getElementById('selection-card').style.display = 'block';
            document.getElementById('team-simulator').style.display = 'block';
        }

        function renderMemberSelection() {
            const container = document.getElementById('member-selection-area');
            container.innerHTML = '';

            allStaffData.forEach((staff, index) => {
                const card = document.createElement('div');
                card.className = 'member-card';
                card.onclick = () => toggleMember(index, card);

                const typeName = svdTypes[staff.type] ? svdTypes[staff.type].name : staff.type;
                const rank = staff.meisterRank || 'Rookie';
                let rankColor = '#546E7A';
                if (rank === 'Master') rankColor = '#FFD700';
                else if (rank === 'Expert') rankColor = '#D84315';
                else if (rank === 'Specialist') rankColor = '#1565C0';
                else if (rank === 'Junior') rankColor = '#43A047';

                card.innerHTML = `
                    <div class="member-info">
                        <h4>${staff.name} <span style="font-size:0.8rem; background:${rankColor}; color:${rank === 'Master' ? 'black' : 'white'}; padding:2px 6px; border-radius:4px;">${rank}</span></h4>
                        <p>${staff.affiliation} / ${staff.jobTitle || '-'} | ${typeName}</p>
                        <p>Score: ${Number(staff.score).toFixed(2)}</p>
                        <p style="font-size:0.8rem; color:#78909C; margin-top:0.2rem;">${staff.qualifications || '-'}</p>
                    </div>
                    <div class="add-icon" style="font-size: 1.5rem; color: var(--border-color);">+</div>
                `;
                container.appendChild(card);
            });
        }

        function toggleMember(index, cardElement) {
            const staff = allStaffData[index];
            // Use unique identifier: name + affiliation + jobTitle
            const staffId = `${staff.name}_${staff.affiliation}_${staff.jobTitle || ''}`;
            const existingIndex = teamMembers.findIndex(m =>
                `${m.name}_${m.affiliation}_${m.jobTitle || ''}` === staffId
            );

            if (existingIndex >= 0) {
                // Remove
                teamMembers.splice(existingIndex, 1);
                cardElement.classList.remove('selected');
                cardElement.querySelector('.add-icon').textContent = '+';
                cardElement.querySelector('.add-icon').style.color = 'var(--border-color)';
            } else {
                // Add
                teamMembers.push(staff);
                cardElement.classList.add('selected');
                cardElement.querySelector('.add-icon').textContent = '✓';
                cardElement.querySelector('.add-icon').style.color = 'var(--secondary-color)';
            }
            updateTeamUI();
        }

        function updateTeamUI() {
            const list = document.getElementById('team-list');
            list.innerHTML = '';
            teamMembers.forEach((member) => {
                const typeName = svdTypes[member.type] ? svdTypes[member.type].name : member.type;
                // Get just the type name without Japanese for the badge if possible, or just use the first letter
                const typeShort = member.type.split(' ')[0];
                const rank = member.meisterRank || 'Rookie';

                const li = document.createElement('li');
                li.style.background = 'white';
                li.style.padding = '1rem';
                li.style.borderRadius = '8px';
                li.style.display = 'flex';
                li.style.justifyContent = 'space-between';
                li.style.alignItems = 'center';
                li.style.boxShadow = '0 2px 5px rgba(0,0,0,0.05)';

                // Type Color mapping (simplified)
                let typeColor = '#546E7A';
                if (['Flare', 'Spark', 'Emperor'].includes(member.type)) typeColor = '#E53935'; // Red-ish
                else if (['Flow', 'Bloom', 'Bliss'].includes(member.type)) typeColor = '#FB8C00'; // Orange-ish
                else if (['Crystal', 'Seraph', 'Wing'].includes(member.type)) typeColor = '#039BE5'; // Blue-ish
                else if (['Ground', 'Solid', 'Iron'].includes(member.type)) typeColor = '#43A047'; // Green-ish
                else if (['Rogue', 'Striker', 'Night Shift'].includes(member.type)) typeColor = '#8E24AA'; // Purple-ish

                li.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div style="
                            width: 40px; 
                            height: 40px; 
                            background: ${typeColor}; 
                            color: white; 
                            border-radius: 50%; 
                            display: flex; 
                            align-items: center; 
                            justify-content: center; 
                            font-weight: bold; 
                            font-family: 'Teko', sans-serif;
                            font-size: 1.2rem;"
                            title="${typeName}">
                            ${typeShort.charAt(0)}
                        </div>
                        <div>
                            <div style="font-weight:bold; font-size:1.1rem;">${member.name}</div>
                            <div style="font-size:0.8rem; color:#90A4AE;">${rank}</div>
                        </div>
                    </div>
                    <div style="font-family: 'Teko', sans-serif; font-size: 1.5rem; font-weight:bold; color:var(--primary-color);">
                        ${Number(member.score).toFixed(1)} <span style="font-size:0.8rem; color:#90A4AE;">pts</span>
                    </div>
                `;
                list.appendChild(li);
            });

            calculateTeamMomentum();
            drawTeamRadarChart();
        }

        function calculateTeamMomentum() {
            if (teamMembers.length === 0) {
                document.getElementById('team-momentum-score').textContent = '0';
                document.getElementById('total-power-score').textContent = '0';
                document.getElementById('synergy-bonus').textContent = '';
                document.getElementById('team-advice').innerHTML = 'メンバーを追加して分析を開始してください。';
                return;
            }

            // Step 1: Base Power (Average Individual Score)
            let totalScore = 0;
            teamMembers.forEach(m => totalScore += Number(m.score));
            const avgScore = totalScore / teamMembers.length;

            // Step 2: Synergy Multiplier (Pairwise Analysis)
            let totalMultiplier = 0;
            let pairCount = 0;
            let bestPairings = [];
            let cautionPairings = [];

            if (teamMembers.length < 2) {
                totalMultiplier = 1.0;
                pairCount = 1;
            } else {
                for (let i = 0; i < teamMembers.length; i++) {
                    for (let j = i + 1; j < teamMembers.length; j++) {
                        const m1 = teamMembers[i];
                        const m2 = teamMembers[j];
                        const type1 = m1.type;
                        const type2 = m2.type;

                        let multiplier = 1.0;

                        // Check Synergy
                        if (synergyData[type1] && (synergyData[type1].best.includes(type2) || (synergyData[type2] && synergyData[type2].best.includes(type1)))) {
                            multiplier = 1.2;
                            bestPairings.push({ name1: m1.name, name2: m2.name, type1: type1, type2: type2, multiplier: 1.2 });
                        } else if (synergyData[type1] && (synergyData[type1].caution.includes(type2) || (synergyData[type2] && synergyData[type2].caution.includes(type1)))) {
                            multiplier = 0.9;
                            cautionPairings.push({ name1: m1.name, name2: m2.name, type1: type1, type2: type2, multiplier: 0.9 });
                        } else if (type1 === type2) {
                            multiplier = 1.1;
                            bestPairings.push({ name1: m1.name, name2: m2.name, type1: type1, type2: type2, multiplier: 1.1 });
                        }

                        totalMultiplier += multiplier;
                        pairCount++;
                    }
                }
            }

            const avgMultiplier = totalMultiplier / pairCount;
            const teamMomentum = avgScore * avgMultiplier;
            const totalMomentum = teamMomentum * teamMembers.length;

            document.getElementById('team-momentum-score').textContent = teamMomentum.toFixed(2);
            document.getElementById('total-power-score').textContent = totalMomentum.toFixed(2);

            let bonusText = `Avg Score: ${avgScore.toFixed(2)} × Synergy: ${avgMultiplier.toFixed(2)}`;
            document.getElementById('synergy-bonus').innerHTML = bonusText;

            // --- Build Advice with separated Best and Caution pairings ---
            let scaleAdvice = "";
            const size = teamMembers.length;

            if (size <= 5) {
                scaleAdvice = `<div style="margin-bottom:0.5rem; padding:0.5rem; background:#E8F5E9; border-left:4px solid #4CAF50;">
                    <strong>Phase: Small (少数精鋭)</strong><br>
                    個々のスキルと相性が全てです。Synergy 1.1以上を目指しましょう。
                </div>`;
            } else if (size <= 12) {
                scaleAdvice = `<div style="margin-bottom:0.5rem; padding:0.5rem; background:#FFF3E0; border-left:4px solid #FF9800;">
                    <strong>Phase: Medium (組織化)</strong><br>
                    バランスが重要です。Total Momentumを高めつつ、Warningペアのケアを行ってください。
                </div>`;
            } else {
                scaleAdvice = `<div style="margin-bottom:0.5rem; padding:0.5rem; background:#E3F2FD; border-left:4px solid #2196F3;">
                    <strong>Phase: Large (大組織)</strong><br>
                    ハレーション防止が最優先です。Synergyが1.0を下回らないように注意してください。
                </div>`;
            }

            let adviceHtml = scaleAdvice;

            // Best Pairings (Top 3)
            adviceHtml += `<div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 0.5rem;">`;

            adviceHtml += `<div style="flex: 1; min-width: 250px; background: #E8F5E9; padding: 0.75rem; border-radius: 8px;">
                <strong style="color: #2E7D32;">✨ Best Match (Top 3)</strong><br>`;
            if (bestPairings.length > 0) {
                bestPairings.slice(0, 3).forEach(p => {
                    adviceHtml += `<div style="margin-top: 0.4rem; font-size: 0.85rem;">
                        ★ <strong>${p.name1}</strong> <span style="color:#888;">(${p.type1})</span> × 
                        <strong>${p.name2}</strong> <span style="color:#888;">(${p.type2})</span>
                    </div>`;
                });
            } else {
                adviceHtml += `<div style="margin-top: 0.3rem; font-size: 0.9rem; color: #666;">該当なし</div>`;
            }
            adviceHtml += `</div>`;

            // Caution Pairings (Top 3)
            adviceHtml += `<div style="flex: 1; min-width: 250px; background: #FFEBEE; padding: 0.75rem; border-radius: 8px;">
                <strong style="color: #C62828;">⚠️ Caution Match (Top 3)</strong><br>`;
            if (cautionPairings.length > 0) {
                cautionPairings.slice(0, 3).forEach(p => {
                    adviceHtml += `<div style="margin-top: 0.4rem; font-size: 0.85rem;">
                        ⚠ <strong>${p.name1}</strong> <span style="color:#888;">(${p.type1})</span> × 
                        <strong>${p.name2}</strong> <span style="color:#888;">(${p.type2})</span>
                    </div>`;
                });
            } else {
                adviceHtml += `<div style="margin-top: 0.3rem; font-size: 0.9rem; color: #666;">該当なし</div>`;
            }
            adviceHtml += `</div>`;

            adviceHtml += `</div>`;

            document.getElementById('team-advice').innerHTML = adviceHtml;
        }

        function drawTeamRadarChart() {
            const ctx = document.getElementById('team-radar-chart').getContext('2d');
            const categories = ["パーソル力", "サービススキル", "経験・資格", "マネジメントスキル"];
            const teamCategoryScores = [0, 0, 0, 0];

            teamMembers.forEach(m => {
                // detailedScores is expected to be an array of 24 numbers
                // If fetching from sheet, it might be a comma-separated string or array
                let scores = m.detailedScores;
                if (typeof scores === 'string') {
                    scores = scores.split(',').map(Number);
                }

                if (!scores || scores.length < 24) return; // Safety check

                let p = 0, s = 0, e = 0, mg = 0;
                for (let i = 0; i < 6; i++) p += scores[i];
                for (let i = 6; i < 12; i++) s += scores[i];
                for (let i = 12; i < 18; i++) e += scores[i];
                for (let i = 18; i < 24; i++) mg += scores[i];

                teamCategoryScores[0] += (p / 6);
                teamCategoryScores[1] += (s / 6);
                teamCategoryScores[2] += (e / 6);
                teamCategoryScores[3] += (mg / 6);
            });

            const count = teamMembers.length || 1;
            const avgData = teamCategoryScores.map(s => s / count);

            if (teamRadarChart) {
                teamRadarChart.destroy();
            }

            teamRadarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: categories,
                    datasets: [{
                        label: 'チーム平均',
                        data: avgData,
                        backgroundColor: 'rgba(184, 153, 92, 0.2)',
                        borderColor: 'rgba(184, 153, 92, 1)',
                        borderWidth: 3,
                        pointBackgroundColor: '#0f172a',
                        pointBorderColor: '#fff',
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        r: {
                            beginAtZero: true,
                            min: 0,
                            max: 11,
                            ticks: {
                                stepSize: 2,
                                color: '#64748b',
                                backdropColor: 'transparent',
                                callback: function (value) {
                                    return value <= 10 ? value : '';
                                }
                            },
                            pointLabels: {
                                font: {
                                    size: 14,
                                    weight: 'bold',
                                    family: 'Montserrat'
                                },
                                color: '#0f172a',
                                padding: 15
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            angleLines: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                font: {
                                    family: 'Montserrat',
                                    weight: '600'
                                },
                                color: '#0f172a'
                            }
                        }
                    }
                }
            });
        }

        // --- SNAPSHOT PDF EXPORT ---
        async function exportPDF() {
            const element = document.getElementById('team-simulator');
            const btn = document.querySelector('#team-simulator button');
            const originalBtnText = btn ? btn.textContent : '';

            const teamNameInput = document.getElementById('team-name-input');
            const teamName = teamNameInput.value || 'My Team';

            // Create temporary title for capture
            const titleDiv = document.createElement('div');
            titleDiv.textContent = teamName;
            titleDiv.style.cssText = `
                font-family: 'Montserrat', sans-serif;
                font-size: 2.5rem;
                font-weight: 800;
                color: #0f172a;
                border-bottom: 3px solid #B8995C;
                margin-bottom: 1.5rem;
                padding-bottom: 0.5rem;
                text-align: center;
                letter-spacing: 0.05em;
            `;

            // Temporarily hide input and button
            const headerContainer = teamNameInput.parentNode;
            headerContainer.insertBefore(titleDiv, teamNameInput);
            teamNameInput.style.display = 'none';

            if (btn) {
                btn.textContent = 'Generating PDF...';
                btn.style.display = 'none';
            }

            // Apply PDF-optimized layout
            element.classList.add('pdf-mode');

            try {
                // Wait for DOM updates and CSS transitions
                await new Promise(resolve => setTimeout(resolve, 400));

                // Get the full scrollable height of the element
                const fullHeight = element.scrollHeight;
                const fullWidth = element.scrollWidth;

                // Capture with html2canvas - specify full dimensions
                const canvas = await html2canvas(element, {
                    scale: 2.5, // Slightly reduced for better performance
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff',
                    height: fullHeight,
                    width: fullWidth,
                    windowHeight: fullHeight,
                    windowWidth: fullWidth
                });

                const imgData = canvas.toDataURL('image/jpeg', 0.95);

                // Create PDF with jsPDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('l', 'mm', 'a4');

                const pageWidth = 297;
                const pageHeight = 210;

                const imgProps = pdf.getImageProperties(imgData);

                // Calculate dimensions to fit on one page
                let pdfWidth = pageWidth;
                let pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

                // If height exceeds page, scale down to fit
                if (pdfHeight > pageHeight) {
                    pdfHeight = pageHeight;
                    pdfWidth = (imgProps.width * pdfHeight) / imgProps.height;
                }

                // Center the image
                const xOffset = (pageWidth - pdfWidth) / 2;
                const yOffset = (pageHeight - pdfHeight) / 2;

                pdf.addImage(imgData, 'JPEG', xOffset, yOffset, pdfWidth, pdfHeight);
                pdf.save(`${teamName}_Analysis.pdf`);

            } catch (err) {
                console.error('PDF Export Error:', err);
                alert('PDF生成に失敗しました: ' + err.message);
            } finally {
                // Restore UI
                element.classList.remove('pdf-mode');
                titleDiv.remove();
                teamNameInput.style.display = 'block';
                if (btn) {
                    btn.textContent = originalBtnText;
                    btn.style.display = '';
                }
            }
        }
    </script>
</body>

</html>