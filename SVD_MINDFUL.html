<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SVD MINDFUL</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="SVD MINDFUL">
    <link rel="apple-touch-icon" sizes="180x180" href="logo/SVD_icon_square.png">
    <link rel="apple-touch-icon" sizes="152x152" href="logo/SVD_icon_square.png">
    <link rel="apple-touch-icon" sizes="120x120" href="logo/SVD_icon_square.png">
    <link rel="apple-touch-icon" href="logo/SVD_icon_square.png">
    <link rel="icon" type="image/png" href="logo/SVD_icon_square.png">
    <link rel="manifest" href="manifest.json">
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Inter:wght@400;500;600&family=Shippori+Mincho:wght@400;600&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --white: #FFFFFF;
            --off-white: #FAFAFA;
            --light-gray: #F5F5F5;
            --navy: #1E3A5F;
            --navy-dark: #0F2A4A;
            --gold: #C9A962;
            --gold-light: rgba(201, 169, 98, 0.15);
            --gold-glow: rgba(201, 169, 98, 0.3);
            --text-dark: #1E3A5F;
            --text-gray: #6B7B8C;
            --border: rgba(30, 58, 95, 0.1);
            --success: #22C55E;
            --warning: #F59E0B;
            --danger: #EF4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Shippori Mincho', serif;
            background-color: var(--off-white);
            color: var(--text-dark);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid var(--border);
            background: var(--white);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
        }

        .logo-container {
            margin-bottom: 8px;
        }

        .logo-container img {
            height: 45px;
        }

        h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 28px;
            font-weight: 600;
            letter-spacing: 0.12em;
            color: var(--navy);
        }

        .header-sub {
            font-family: 'Montserrat', sans-serif;
            font-size: 10px;
            color: var(--gold);
            letter-spacing: 0.25em;
            margin-top: 4px;
            font-weight: 500;
        }

        .user-badge {
            font-family: 'Inter', sans-serif;
            font-size: 11px;
            color: var(--text-gray);
            margin-top: 10px;
            padding: 5px 14px;
            background: var(--light-gray);
            border-radius: 20px;
            display: inline-block;
        }

        /* TOKEN SYSTEM */
        .token-display {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, rgba(201, 169, 98, 0.15), rgba(201, 169, 98, 0.05));
            border: 1px solid var(--gold);
            padding: 6px 14px;
            border-radius: 25px;
            margin-top: 10px;
            margin-left: 8px;
        }

        .token-icon {
            font-size: 16px;
            animation: coinSpin 3s linear infinite;
        }

        @keyframes coinSpin {

            0%,
            100% {
                transform: rotateY(0deg);
            }

            50% {
                transform: rotateY(180deg);
            }
        }

        .token-balance {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 13px;
            color: var(--gold);
        }

        .token-label {
            font-family: 'Montserrat', sans-serif;
            font-size: 9px;
            letter-spacing: 0.1em;
            color: var(--text-gray);
        }

        /* TOKEN EARNED ANIMATION */
        .token-earned-container {
            text-align: center;
            margin: 20px 0;
        }

        .token-earned-badge {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 30px;
            background: linear-gradient(145deg, var(--navy), var(--navy-dark));
            border: 2px solid var(--gold);
            border-radius: 16px;
            box-shadow: 0 0 30px var(--gold-glow);
            animation: tokenPulse 2s ease-in-out infinite;
        }

        @keyframes tokenPulse {

            0%,
            100% {
                box-shadow: 0 0 20px var(--gold-glow);
            }

            50% {
                box-shadow: 0 0 40px var(--gold), 0 0 60px var(--gold-glow);
            }
        }

        .token-earned-icon {
            font-size: 40px;
            margin-bottom: 8px;
            animation: tokenBounce 0.6s ease-out;
        }

        @keyframes tokenBounce {
            0% {
                transform: scale(0) rotate(-45deg);
            }

            50% {
                transform: scale(1.2) rotate(10deg);
            }

            100% {
                transform: scale(1) rotate(0);
            }
        }

        .token-earned-amount {
            font-family: 'Montserrat', sans-serif;
            font-size: 28px;
            font-weight: 700;
            color: var(--gold);
            text-shadow: 0 0 12px var(--gold-glow);
        }

        .token-earned-label {
            font-family: 'Montserrat', sans-serif;
            font-size: 10px;
            letter-spacing: 0.2em;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 4px;
        }

        .token-breakdown {
            margin-top: 12px;
            font-family: 'Inter', sans-serif;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
        }

        .token-breakdown-item {
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }

        main {
            flex-grow: 1;
            padding: 22px;
            overflow-y: auto;
            padding-bottom: 120px;
        }

        .screen {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 11px;
            color: var(--gold);
            letter-spacing: 0.25em;
            text-transform: uppercase;
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
        }

        .section-title::before,
        .section-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--gold-light), transparent);
        }

        /* REGISTRATION */
        .register-card {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 30px 25px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04);
        }

        .register-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 8px;
            letter-spacing: 0.05em;
            color: var(--navy);
        }

        .register-sub {
            font-size: 13px;
            color: var(--text-gray);
            margin-bottom: 25px;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-label {
            font-family: 'Montserrat', sans-serif;
            font-size: 10px;
            color: var(--gold);
            letter-spacing: 0.15em;
            margin-bottom: 8px;
            display: block;
            font-weight: 600;
        }

        .text-input {
            width: 100%;
            background: var(--light-gray);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px 16px;
            color: var(--text-dark);
            font-family: 'Inter', sans-serif;
            font-size: 15px;
        }

        .text-input::placeholder {
            color: var(--text-gray);
        }

        .text-input:focus {
            outline: none;
            border-color: var(--gold);
        }

        .base-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .base-option {
            padding: 16px 12px;
            background: var(--light-gray);
            border: 1px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .base-option:hover {
            border-color: var(--gold);
        }

        .base-option.selected {
            border-color: var(--gold);
            background: var(--gold-light);
        }

        .base-icon {
            font-size: 24px;
            margin-bottom: 6px;
        }

        .base-name {
            font-family: 'Inter', sans-serif;
            font-size: 12px;
            font-weight: 600;
            color: var(--navy);
        }

        .base-code {
            font-family: 'Montserrat', sans-serif;
            font-size: 9px;
            color: var(--text-gray);
            letter-spacing: 0.1em;
            margin-top: 3px;
        }

        /* PRINCIPLES */
        .principle-card {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 20px;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
        }

        .principle-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--gold), rgba(201, 169, 98, 0.3));
        }

        .principle-num {
            font-family: 'Montserrat', sans-serif;
            font-size: 18px;
            color: var(--gold);
            letter-spacing: 0.05em;
            font-weight: 700;
        }

        .principle-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 11px;
            font-weight: 600;
            margin: 2px 0 8px 0;
            letter-spacing: 0.05em;
            color: var(--navy);
        }

        .principle-desc {
            font-size: 12px;
            color: var(--text-gray);
            line-height: 1.7;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding-top 0.3s ease;
            padding-top: 0;
        }

        .principle-card.expanded .principle-desc {
            max-height: 300px;
            padding-top: 10px;
        }

        .principle-card {
            cursor: pointer;
        }

        .principle-card::after {
            content: 'â–¼';
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 10px;
            color: var(--gold);
            transition: transform 0.3s ease;
        }

        .principle-card.expanded::after {
            transform: rotate(180deg);
        }

        /* HEALTH CHECK */
        .health-check-card {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 20px;
            margin-bottom: 18px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
        }

        .health-check-card.complete {
            border-color: rgba(34, 197, 94, 0.4);
            background: linear-gradient(145deg, rgba(34, 197, 94, 0.05), var(--white));
        }

        .health-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            letter-spacing: 0.05em;
            color: var(--navy);
        }

        .health-title .icon {
            font-size: 18px;
        }

        .check-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .check-item:last-child {
            border-bottom: none;
        }

        .check-label {
            font-size: 13px;
            color: var(--text-dark);
            flex: 1;
        }

        .check-toggle {
            display: flex;
            gap: 6px;
        }

        .toggle-btn {
            padding: 7px 14px;
            border-radius: 18px;
            border: 1px solid var(--border);
            background: var(--light-gray);
            color: var(--text-gray);
            font-family: 'Inter', sans-serif;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toggle-btn.ok.selected {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .toggle-btn.ng.selected {
            background: var(--danger);
            border-color: var(--danger);
            color: white;
        }

        .toggle-btn.selected {
            background: var(--gold);
            border-color: var(--gold);
            color: white;
        }

        .health-status {
            text-align: center;
            padding: 12px;
            margin-top: 12px;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 12px;
        }

        .health-status.ok {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success);
        }

        .health-status.incomplete {
            background: var(--light-gray);
            color: var(--text-gray);
        }

        .health-status.ng {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        /* DRAW AREA */
        .draw-area {
            text-align: center;
            padding: 25px 20px;
            margin-top: 12px;
        }

        .draw-area.disabled {
            opacity: 0.25;
            pointer-events: none;
        }

        .draw-card-back {
            width: 140px;
            height: 190px;
            margin: 0 auto;
            background: linear-gradient(145deg, var(--navy), var(--navy-dark));
            border: 2px solid var(--gold);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 6px 25px rgba(30, 58, 95, 0.2), 0 0 20px var(--gold-glow);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .draw-card-back::before {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            bottom: 5px;
            border: 1px solid rgba(201, 169, 98, 0.4);
            border-radius: 8px;
        }

        .draw-card-back:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 35px rgba(30, 58, 95, 0.25), 0 0 30px var(--gold-glow);
        }

        .draw-logo {
            font-family: 'Montserrat', sans-serif;
            font-size: 32px;
            font-weight: 700;
            color: var(--gold);
            text-shadow: 0 0 12px var(--gold-glow);
        }

        .draw-subtitle {
            font-family: 'Montserrat', sans-serif;
            font-size: 8px;
            color: rgba(255, 255, 255, 0.7);
            letter-spacing: 0.2em;
            margin-top: 5px;
        }

        .draw-hint {
            font-family: 'Inter', sans-serif;
            font-size: 10px;
            color: var(--text-gray);
            margin-top: 18px;
            opacity: 0.7;
        }

        /* QUEST CARDS CONTAINER */
        .quest-cards-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .quest-card {
            background: linear-gradient(145deg, var(--navy), var(--navy-dark));
            border: 1px solid var(--gold);
            border-radius: 14px;
            padding: 18px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(30, 58, 95, 0.15);
            animation: revealCard 0.5s ease;
            display: none;
        }

        .quest-card.revealed {
            display: block;
        }

        @keyframes revealCard {
            0% {
                opacity: 0;
                transform: scale(0.9) rotateY(90deg);
            }

            50% {
                opacity: 1;
                transform: scale(1.02) rotateY(0deg);
            }

            100% {
                transform: scale(1);
            }
        }

        .quest-label {
            font-family: 'Montserrat', sans-serif;
            font-size: 9px;
            color: var(--gold);
            letter-spacing: 0.25em;
            font-weight: 600;
        }

        .quest-number {
            font-family: 'Montserrat', sans-serif;
            font-size: 32px;
            font-weight: 700;
            color: var(--gold);
            text-shadow: 0 0 20px var(--gold-glow);
            margin: 4px 0;
        }

        .quest-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 2px;
            letter-spacing: 0.02em;
            color: white;
        }

        .quest-subtitle {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 8px;
        }

        .quest-philosophy {
            font-size: 12px;
            line-height: 1.7;
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            border-radius: 8px;
            margin-top: 8px;
            color: rgba(255, 255, 255, 0.9);
        }

        /* BUTTONS */
        .btn-main {
            background: var(--gold);
            color: var(--navy-dark);
            border: none;
            padding: 15px;
            border-radius: 50px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 13px;
            letter-spacing: 0.1em;
            width: 100%;
            cursor: pointer;
            box-shadow: 0 4px 15px var(--gold-glow);
            transition: all 0.2s;
            margin-top: 18px;
        }

        .btn-main:disabled {
            opacity: 0.25;
            cursor: not-allowed;
        }

        .btn-main:hover:not(:disabled) {
            box-shadow: 0 6px 20px var(--gold-glow);
        }

        .btn-main:active:not(:disabled) {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-gray);
            padding: 11px;
            border-radius: 50px;
            font-family: 'Inter', sans-serif;
            font-size: 11px;
            width: 100%;
            cursor: pointer;
            margin-top: 8px;
        }

        .btn-secondary:hover {
            border-color: var(--gold);
            color: var(--gold);
        }

        /* ACTIVE DAY */
        .active-quests-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .active-quest-card {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 18px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
            position: relative;
            overflow: hidden;
        }

        .active-quest-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--gold), rgba(201, 169, 98, 0.3));
        }

        .active-quest-card .quest-number {
            font-size: 36px;
            color: var(--navy);
            text-shadow: none;
        }

        .active-quest-card .quest-title {
            color: var(--navy);
            font-size: 14px;
        }

        .active-quest-card .quest-subtitle {
            color: var(--text-gray);
            font-size: 11px;
        }

        .active-quest-card .quest-philosophy {
            background: var(--light-gray);
            color: var(--text-dark);
            font-size: 11px;
        }

        .countdown-section {
            text-align: center;
            margin-top: 25px;
            padding: 20px;
            background: var(--white);
            border-radius: 14px;
            border: 1px solid var(--border);
        }

        .countdown-label {
            font-family: 'Montserrat', sans-serif;
            font-size: 10px;
            color: var(--text-gray);
            letter-spacing: 0.2em;
        }

        .countdown-time {
            font-family: 'Montserrat', sans-serif;
            font-size: 36px;
            font-weight: 600;
            color: var(--navy);
            margin-top: 5px;
        }

        /* REFLECTION */
        .reflection-prompt {
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 22px;
            line-height: 1.7;
            color: var(--navy);
        }

        .star-rating {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 22px;
        }

        .star {
            font-size: 36px;
            cursor: pointer;
            color: var(--light-gray);
            transition: all 0.2s;
        }

        .star.active,
        .star:hover {
            color: var(--gold);
            transform: scale(1.1);
        }

        .memo-input {
            width: 100%;
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px;
            color: var(--text-dark);
            font-family: 'Shippori Mincho', serif;
            font-size: 13px;
            resize: none;
            height: 90px;
            line-height: 1.7;
        }

        .memo-input::placeholder {
            color: var(--text-gray);
        }

        .memo-input:focus {
            outline: none;
            border-color: var(--gold);
        }

        /* COMPLETION */
        .completion-icon {
            font-size: 60px;
            text-align: center;
            margin-bottom: 18px;
        }

        .completion-message {
            font-family: 'Montserrat', sans-serif;
            font-size: 24px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 6px;
            color: var(--navy);
        }

        .completion-sub {
            font-size: 13px;
            color: var(--text-gray);
            text-align: center;
            line-height: 1.7;
        }

        /* HISTORY */
        .history-item {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.02);
        }

        .history-date {
            font-family: 'Inter', sans-serif;
            font-size: 10px;
            color: var(--text-gray);
        }

        .history-quest {
            font-family: 'Montserrat', sans-serif;
            font-size: 12px;
            font-weight: 600;
            color: var(--navy);
        }

        .history-stars {
            color: var(--gold);
            font-size: 12px;
        }

        /* FOOTER */
        footer {
            padding: 12px;
            text-align: center;
            border-top: 1px solid var(--border);
            background: var(--white);
            font-family: 'Montserrat', sans-serif;
            font-size: 9px;
            letter-spacing: 0.3em;
            color: var(--text-gray);
        }

        /* NAV */
        nav {
            display: flex;
            border-top: 1px solid var(--border);
            background: var(--white);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.03);
        }

        .nav-item {
            flex: 1;
            padding: 11px 0;
            text-align: center;
            font-family: 'Montserrat', sans-serif;
            font-size: 8px;
            letter-spacing: 0.05em;
            color: var(--text-gray);
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-item.active {
            color: var(--gold);
        }

        .nav-icon {
            font-size: 16px;
            margin-bottom: 2px;
        }

        /* SENDING OVERLAY */
        .sending-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }

        .sending-overlay.active {
            display: flex;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--light-gray);
            border-top-color: var(--gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .sending-text {
            font-family: 'Montserrat', sans-serif;
            font-size: 12px;
            color: var(--text-gray);
            margin-top: 15px;
            letter-spacing: 0.1em;
        }
    </style>
</head>

<body>

    <header>
        <div class="logo-container">
            <img src="logo/SVD_logo_standard.png" alt="SVD" onerror="this.style.display='none'">
        </div>
        <h1>MINDFUL</h1>
        <div class="header-sub">IGNITION â€” GET YOUR GREEN LIGHT</div>
        <div style="display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 5px;">
            <div class="user-badge" id="userBadge" style="display: none;"></div>
            <div class="token-display" id="tokenDisplay" style="display: none;">
                <span class="token-icon">ğŸª™</span>
                <span class="token-balance" id="tokenBalance">0</span>
                <span class="token-label">TOKEN</span>
            </div>
        </div>
        <!-- Goals Display -->
        <div id="goalsDisplay"
            style="display: none; margin-top: 12px; padding: 12px 16px; background: var(--gold-light); border: 1px solid var(--gold); border-radius: 12px; text-align: left; max-width: 350px; margin-left: auto; margin-right: auto;">
            <div
                style="font-family: 'Montserrat', sans-serif; font-size: 9px; color: var(--gold); letter-spacing: 0.15em; margin-bottom: 8px; font-weight: 600;">
                ğŸ“Œ MY VISION</div>
            <div style="display: flex; align-items: flex-start; gap: 12px;">
                <!-- Photo in MY VISION -->
                <div id="goalsPhotoContainer"
                    style="width: 50px; height: 50px; border-radius: 50%; background: var(--light-gray); border: 2px solid var(--gold); display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0;">
                    <img id="goalsPhoto" src="" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                    <span id="goalsPhotoPlaceholder" style="font-size: 24px;">ğŸ‘¤</span>
                </div>
                <div style="flex: 1; font-size: 11px;">
                    <div style="color: var(--navy); margin-bottom: 6px;">
                        <strong style="color: var(--gold);">ğŸ¯ ä»Šå¹´ã®ç›®æ¨™</strong>
                        <div id="goalsThisYearList" style="margin-top: 3px; color: var(--text-gray);">-</div>
                    </div>
                    <div style="color: var(--navy);">
                        <strong style="color: var(--gold);">âœ¨ SVDã§å¶ãˆãŸã„ã‚­ãƒ£ãƒªã‚¢ã¾ãŸã¯å°†æ¥ã®å¤¢</strong>
                        <div id="goalsFutureList" style="margin-top: 3px; color: var(--text-gray);">-</div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main>
        <!-- SCREEN 0: REGISTRATION -->
        <div class="screen" id="screen-register">
            <div class="register-card">
                <div class="register-title">Welcome to MINDFUL</div>
                <div class="register-sub">ã‚ãªãŸã®æƒ…å ±ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</div>
                <div class="input-group">
                    <label class="input-label">YOUR NAME</label>
                    <input type="text" class="text-input" id="inputName" placeholder="ä¾‹: å±±ç”°å¤ªéƒ">
                </div>
                <div class="input-group">
                    <label class="input-label">YOUR BASE</label>
                    <div class="base-selector">
                        <div class="base-option" data-base="moiwayama" onclick="selectBase(this)">
                            <div class="base-icon">ğŸ”ï¸</div>
                            <div class="base-name">è—»å²©å±±</div>
                            <div class="base-code">MOIWAYAMA</div>
                        </div>
                        <div class="base-option" data-base="okurayama" onclick="selectBase(this)">
                            <div class="base-icon">â›·ï¸</div>
                            <div class="base-name">å¤§å€‰å±±</div>
                            <div class="base-code">OKURAYAMA</div>
                        </div>
                        <div class="base-option" data-base="tvtower" onclick="selectBase(this)">
                            <div class="base-icon">ğŸ—¼</div>
                            <div class="base-name">ãƒ†ãƒ¬ãƒ“å¡”</div>
                            <div class="base-code">TV TOWER</div>
                        </div>
                        <div class="base-option" data-base="akarenga" onclick="selectBase(this)">
                            <div class="base-icon">ğŸ§±</div>
                            <div class="base-name">èµ¤ã‚Œã‚“ãŒ</div>
                            <div class="base-code">AKARENGA</div>
                        </div>
                    </div>
                </div>
                <div class="input-group">
                    <label class="input-label">ğŸ¯ ä»Šå¹´ã®ç›®æ¨™ï¼ˆ3ã¤ã¾ã§ï¼‰</label>
                    <input type="text" class="text-input" id="inputGoalThisYear1" placeholder="ç›®æ¨™ 1"
                        style="margin-bottom: 8px;">
                    <input type="text" class="text-input" id="inputGoalThisYear2" placeholder="ç›®æ¨™ 2ï¼ˆä»»æ„ï¼‰"
                        style="margin-bottom: 8px;">
                    <input type="text" class="text-input" id="inputGoalThisYear3" placeholder="ç›®æ¨™ 3ï¼ˆä»»æ„ï¼‰">
                </div>
                <div class="input-group">
                    <label class="input-label">âœ¨ SVDã§å¶ãˆãŸã„ã‚­ãƒ£ãƒªã‚¢ã¾ãŸã¯å°†æ¥ã®å¤¢ï¼ˆ3ã¤ã¾ã§ï¼‰</label>
                    <input type="text" class="text-input" id="inputGoalFuture1" placeholder="å¤¢ 1"
                        style="margin-bottom: 8px;">
                    <input type="text" class="text-input" id="inputGoalFuture2" placeholder="å¤¢ 2ï¼ˆä»»æ„ï¼‰"
                        style="margin-bottom: 8px;">
                    <input type="text" class="text-input" id="inputGoalFuture3" placeholder="å¤¢ 3ï¼ˆä»»æ„ï¼‰">
                </div>
                <button class="btn-main" id="registerBtn" onclick="register()" disabled>REGISTER</button>
            </div>
        </div>

        <!-- SCREEN 1: MORNING RITUAL -->
        <div class="screen" id="screen-morning">
            <!-- Today's Work Location Selector -->
            <div class="section-title">ğŸ“ TODAY'S LOCATION</div>
            <div class="health-check-card" id="todayLocationCard" style="margin-bottom: 20px;">
                <div class="health-title"><span class="icon">ğŸ¢</span> ä»Šæ—¥ã¯ã©ã“ã§åƒãã¾ã™ã‹ï¼Ÿ</div>
                <div class="base-selector" style="margin-top: 12px;">
                    <div class="base-option today-base" data-base="moiwayama" onclick="selectTodayBase(this)">
                        <div class="base-icon">ğŸ”ï¸</div>
                        <div class="base-name">è—»å²©å±±</div>
                        <div class="base-code">MOIWAYAMA</div>
                    </div>
                    <div class="base-option today-base" data-base="okurayama" onclick="selectTodayBase(this)">
                        <div class="base-icon">â›·ï¸</div>
                        <div class="base-name">å¤§å€‰å±±</div>
                        <div class="base-code">OKURAYAMA</div>
                    </div>
                    <div class="base-option today-base" data-base="tvtower" onclick="selectTodayBase(this)">
                        <div class="base-icon">ğŸ—¼</div>
                        <div class="base-name">ãƒ†ãƒ¬ãƒ“å¡”</div>
                        <div class="base-code">TV TOWER</div>
                    </div>
                    <div class="base-option today-base" data-base="akarenga" onclick="selectTodayBase(this)">
                        <div class="base-icon">ğŸ§±</div>
                        <div class="base-name">èµ¤ã‚Œã‚“ãŒ</div>
                        <div class="base-code">AKARENGA</div>
                    </div>
                </div>
                <div id="todayLocationStatus"
                    style="margin-top: 12px; text-align: center; font-size: 11px; color: var(--text-gray);">å‹¤å‹™å…ˆã‚’é¸æŠã—ã¦ãã ã•ã„
                </div>
            </div>

            <div class="section-title">PRINCIPLE</div>
            <div class="principle-card" onclick="this.classList.toggle('expanded')">
                <div class="principle-num">01 PURPOSE</div>
                <div class="principle-title">ãƒ‘ãƒ¼ãƒ‘ã‚¹ï¼ˆå­˜åœ¨æ„ç¾©ï¼‰</div>
                <div class="principle-desc" style="font-weight: 500;">SAPPORO VIEWTIFUL
                    DININGã¯æœ­å¹Œã¨ã„ã†éƒ½å¸‚ãŒæœ‰ã™ã‚‹ã€Œè¦³å…‰ã€ã‚„ã€Œé£Ÿã€ã‚’å®ˆã‚Šã€åŒ—æµ·é“ã®æ–‡åŒ–ã‚’ã€Œæœªæ¥ã€ã¸ã¨ç´¡ãæ——æ‰‹ã¨ãªã‚‹ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ãƒ»ã‚³ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ãƒ«ã§ã™ã€‚</div>
            </div>
            <div class="principle-card" onclick="this.classList.toggle('expanded')">
                <div class="principle-num">02 MISSION</div>
                <div class="principle-title">ã€Œã“ã“ã ã‘ã®ç¾å‘³ã—ã•ã€‚<br>ã“ã“ã ã‘ã®ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ†ã‚¤ãƒ³ãƒ¡ãƒ³ãƒˆã€‚ã€</div>
                <div class="principle-desc" style="font-weight: 500;">
                    ã”æ¥åº—ã„ãŸã ããŠå®¢æ§˜ã®å¤§åˆ‡ãªã‚·ãƒ¼ãƒ³ã‚’å½©ã‚‹ç‰¹åˆ¥ãªæ–™ç†ã¨ç©ºé–“ã‚’æä¾›ã—ã€ã€Œã“ã“ã€ã«ã—ã‹ãªã„ç¾å‘³ã—ã•ã¨æ„Ÿå‹•ã‚’è¿½æ±‚ã—ã€å±Šã‘ã¦ã„ãã¾ã™ã€‚</div>
            </div>
            <div class="principle-card" onclick="this.classList.toggle('expanded')">
                <div class="principle-num">03 VISION</div>
                <div class="principle-title">ã“ã®è¡—ã®é£Ÿã¨æ–‡åŒ–ã¨ç‰©èªã‚’100å¹´å…ˆã¸</div>
                <div class="principle-desc" style="font-weight: 500;">
                    100å¹´å…ˆã‚‚æœ­å¹Œå¸‚æ°‘ã«æ„›ã•ã‚Œã‚‹ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã¥ãã‚Šã€‚ç§ãŸã¡ãŒç›®æŒ‡ã™ã®ã¯ã€ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã®ä¾¡å€¤ã‚’ã€Œé£Ÿã€ã ã‘ã§ã¯ãªãã€Œäººç”Ÿã®ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’å‰µã‚‹å ´æ‰€ã€ã¸ã¨é€²åŒ–ã•ã›ã€æœ­å¹Œã®è¡—å…¨ä½“ã‚’ã‚ˆã‚Šè±Šã‹ãªç‰©èªã‚’ç´¡ãå ´ã¨ã—ã¦ã„ãã“ã¨ã€‚ãã—ã¦ã€ã“ã®è¡—ã®ç¾ã—ã„ç‰©èªãŒæ¬¡ã®ä¸–ä»£ã«ã‚‚å—ã‘ç¶™ãŒã‚Œã¦ã„ãã“ã¨ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚
                </div>
            </div>
            <div class="principle-card" onclick="this.classList.toggle('expanded')">
                <div class="principle-num">04 VALUE</div>
                <div class="principle-title">è¡—ã®æœªæ¥ã‚’ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã‹ã‚‰ã¤ãã£ã¦ã„ã</div>
                <div class="principle-desc" style="font-weight: 500;">
                    ç§ãŸã¡ã®å–ã‚Šçµ„ã¿ã¯ã€å˜ãªã‚‹é£²é£Ÿåº—ã®é‹å–¶ã§ã¯ãªãã€æœ­å¹Œã®æœªæ¥ã‚’å½¢ã¥ãã‚‹å­˜åœ¨ã«ãªã‚‹ã“ã¨ã€‚ãŸã ã®å•†æ¥­æ–½è¨­ã§ã¯ãªã„ã€Œå…¬å…±æ€§ã¨æ–‡åŒ–æ€§ã‚’å‚™ãˆãŸãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã€ã‚’è‚²ã¦ã€ç¤¾å†…ã®å„äº‹æ¥­éƒ¨ã®çš†ã•ã‚“ã¨é€£æºã—ãªãŒã‚‰ã€æœ­å¹Œã®æˆé•·ã¨ã¨ã‚‚ã«æ–°ã—ã„ä¾¡å€¤ã‚’å‰µã‚Šã ã—ã¦ã„ãã¾ã™ã€‚
                </div>
            </div>

            <div class="section-title" style="margin-top: 25px;">Health Check</div>
            <div class="health-check-card" id="healthCheckCard">
                <div class="health-title"><span class="icon">ğŸ©º</span> å°±æ¥­å‰ãƒã‚§ãƒƒã‚¯ã‚·ãƒ¼ãƒˆ</div>
                <div class="check-item">
                    <div class="check-label">ä½“èª¿ã¯è‰¯å¥½ã§ã™ã‹ï¼Ÿ</div>
                    <div class="check-toggle"><button class="toggle-btn ok" data-field="condition"
                            onclick="setCheck(this, 'ok')">OK</button><button class="toggle-btn ng"
                            data-field="condition" onclick="setCheck(this, 'ng')">NG</button></div>
                </div>
                <div class="check-item">
                    <div class="check-label">ä½“æ¸©ã¯37.5â„ƒæœªæº€ã§ã™ã‹ï¼Ÿ</div>
                    <div class="check-toggle"><button class="toggle-btn ok" data-field="temp"
                            onclick="setCheck(this, 'ok')">OK</button><button class="toggle-btn ng" data-field="temp"
                            onclick="setCheck(this, 'ng')">NG</button></div>
                </div>
                <div class="check-item">
                    <div class="check-label">ä½“ãŒã ã‚‹ããªã„ã§ã™ã‹ï¼Ÿ</div>
                    <div class="check-toggle"><button class="toggle-btn ok" data-field="fatigue"
                            onclick="setCheck(this, 'ok')">OK</button><button class="toggle-btn ng" data-field="fatigue"
                            onclick="setCheck(this, 'ng')">NG</button></div>
                </div>
                <div class="check-item">
                    <div class="check-label">èƒ¸ã®ã‚€ã‹ã¤ããƒ»åãæ°—ã¯ãªã„ã§ã™ã‹ï¼Ÿ</div>
                    <div class="check-toggle"><button class="toggle-btn ok" data-field="nausea"
                            onclick="setCheck(this, 'ok')">OK</button><button class="toggle-btn ng" data-field="nausea"
                            onclick="setCheck(this, 'ng')">NG</button></div>
                </div>
                <div class="check-item">
                    <div class="check-label">çˆªã®æ‰‹å…¥ã‚Œã¯ã§ãã¦ã„ã¾ã™ã‹ï¼Ÿ</div>
                    <div class="check-toggle"><button class="toggle-btn ok" data-field="nails"
                            onclick="setCheck(this, 'ok')">OK</button><button class="toggle-btn ng" data-field="nails"
                            onclick="setCheck(this, 'ng')">NG</button></div>
                </div>
                <div class="check-item">
                    <div class="check-label">æ‰‹æŒ‡ã«ç«å‚·ã‚„æ‰‹è’ã‚Œã¯ãªã„ã§ã™ã‹ï¼Ÿ</div>
                    <div class="check-toggle"><button class="toggle-btn ok" data-field="hands"
                            onclick="setCheck(this, 'ok')">OK</button><button class="toggle-btn ng" data-field="hands"
                            onclick="setCheck(this, 'ng')">NG</button></div>
                </div>
                <div class="check-item">
                    <div class="check-label">åˆ¶æœãƒ»é ­é«ªãƒ»é´ã¯æ¸…æ½”ã§ã™ã‹ï¼Ÿ</div>
                    <div class="check-toggle"><button class="toggle-btn ok" data-field="uniform"
                            onclick="setCheck(this, 'ok')">OK</button><button class="toggle-btn ng" data-field="uniform"
                            onclick="setCheck(this, 'ng')">NG</button></div>
                </div>
                <div class="health-status incomplete" id="healthStatus">ã™ã¹ã¦ã®é …ç›®ã‚’ç¢ºèªã—ã¦ãã ã•ã„</div>
            </div>

            <div class="section-title" style="margin-top: 20px;">Mind Check</div>
            <div class="health-check-card" id="mindCheckCard">
                <div class="health-title"><span class="icon">ğŸ’­</span> å¿ƒã®ã‚»ãƒ«ãƒ•ãƒã‚§ãƒƒã‚¯</div>
                <div class="check-item" style="flex-direction: column; align-items: flex-start;">
                    <div class="check-label" style="margin-bottom: 10px;">æœ€è¿‘1é€±é–“ã§ã€ä»•äº‹ã‚’æ¥½ã—ã„ã¨æ„Ÿã˜ãŸã“ã¨ãŒã‚ã‚‹</div>
                    <div class="check-toggle"
                        style="width: 100%; display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <button class="toggle-btn" data-field="mind_enjoy"
                            onclick="setMindCheck(this, 'many')">ãŸãã•ã‚“ã‚ã‚‹</button>
                        <button class="toggle-btn" data-field="mind_enjoy"
                            onclick="setMindCheck(this, 'yes')">ã‚ã‚‹</button>
                        <button class="toggle-btn" data-field="mind_enjoy"
                            onclick="setMindCheck(this, 'neutral')">ã©ã¡ã‚‰ã¨ã‚‚</button>
                        <button class="toggle-btn" data-field="mind_enjoy"
                            onclick="setMindCheck(this, 'no')">ãªã„</button>
                    </div>
                </div>
                <div class="check-item" style="flex-direction: column; align-items: flex-start;">
                    <div class="check-label" style="margin-bottom: 10px;">æœã€ä»•äº‹ã«å‘ã‹ã†ã¨ãã®ç¬¬ä¸€æ„Ÿæƒ…ã¯ï¼Ÿ</div>
                    <div class="check-toggle"
                        style="width: 100%; display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <button class="toggle-btn" data-field="mind_morning"
                            onclick="setMindCheck(this, 'excited')">æ¥½ã—ã¿</button>
                        <button class="toggle-btn" data-field="mind_morning"
                            onclick="setMindCheck(this, 'normal')">æ™®é€š</button>
                        <button class="toggle-btn" data-field="mind_morning"
                            onclick="setMindCheck(this, 'heavy')">å°‘ã—é‡ã„</button>
                        <button class="toggle-btn" data-field="mind_morning"
                            onclick="setMindCheck(this, 'very_heavy')">ã‹ãªã‚Šé‡ã„</button>
                    </div>
                </div>
                <div class="check-item" style="flex-direction: column; align-items: flex-start;">
                    <div class="check-label" style="margin-bottom: 10px;">ç›¸è«‡ã—ãŸã„ã“ã¨ã¯ï¼Ÿ</div>
                    <div class="check-toggle"
                        style="width: 100%; display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <button class="toggle-btn" data-field="mind_consult"
                            onclick="setMindCheck(this, 'urgent')">ã™ãã«ã§ã‚‚</button>
                        <button class="toggle-btn" data-field="mind_consult"
                            onclick="setMindCheck(this, 'sometime')">æŠ˜ã‚’è¦‹ã¦</button>
                        <button class="toggle-btn" data-field="mind_consult"
                            onclick="setMindCheck(this, 'notyet')">ã¾ã å¤§ä¸ˆå¤«</button>
                        <button class="toggle-btn" data-field="mind_consult"
                            onclick="setMindCheck(this, 'none')">ãªã„</button>
                    </div>
                </div>
                <div class="health-status incomplete" id="mindStatus">å¿ƒã®çŠ¶æ…‹ã‚‚ç¢ºèªã—ã¦ãã ã•ã„</div>
            </div>

            <div class="section-title" style="margin-top: 20px;">Today's Quests</div>
            <div class="draw-area disabled" id="drawArea">
                <div class="draw-card-back" onclick="drawQuests()">
                    <div class="draw-logo">SVD</div>
                    <div class="draw-subtitle">PLAYBOOK 100</div>
                </div>
                <div class="draw-hint">å…¨é …ç›®OKã§3æšã®ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã‘ã¾ã™</div>
            </div>

            <div class="quest-cards-container" id="questCardsContainer"></div>
            <button class="btn-main" id="startBtn" style="display: none;" onclick="startDay()">CHECK IN âœ“</button>
        </div>

        <!-- SCREEN 2: ACTIVE DAY -->
        <div class="screen" id="screen-active">
            <div class="section-title">Today's Shift</div>
            <div class="health-check-card" style="padding: 16px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <select id="shiftStartSelect" onchange="shiftTimes.start = this.value"
                        style="flex: 1; padding: 12px; border: 1px solid var(--border); border-radius: 10px; font-size: 16px; font-family: 'Inter', sans-serif; background: var(--light-gray); color: var(--navy); font-weight: 600; text-align: center;">
                        <option value="">é–‹å§‹</option>
                        <option value="08:00">8:00</option>
                        <option value="08:30">8:30</option>
                        <option value="09:00">9:00</option>
                        <option value="09:30">9:30</option>
                        <option value="10:00">10:00</option>
                        <option value="10:30">10:30</option>
                        <option value="11:00">11:00</option>
                        <option value="11:30">11:30</option>
                        <option value="12:00">12:00</option>
                        <option value="12:30">12:30</option>
                        <option value="13:00">13:00</option>
                        <option value="13:30">13:30</option>
                        <option value="14:00">14:00</option>
                        <option value="14:30">14:30</option>
                        <option value="15:00">15:00</option>
                        <option value="15:30">15:30</option>
                        <option value="16:00">16:00</option>
                        <option value="16:30">16:30</option>
                        <option value="17:00">17:00</option>
                    </select>
                    <span style="font-weight: 700; color: var(--navy); font-size: 18px;">ã€œ</span>
                    <select id="shiftEndSelect" onchange="shiftTimes.end = this.value"
                        style="flex: 1; padding: 12px; border: 1px solid var(--border); border-radius: 10px; font-size: 16px; font-family: 'Inter', sans-serif; background: var(--light-gray); color: var(--navy); font-weight: 600; text-align: center;">
                        <option value="">çµ‚äº†</option>
                        <option value="17:00">17:00</option>
                        <option value="17:30">17:30</option>
                        <option value="18:00">18:00</option>
                        <option value="18:30">18:30</option>
                        <option value="19:00">19:00</option>
                        <option value="19:30">19:30</option>
                        <option value="20:00">20:00</option>
                        <option value="20:30">20:30</option>
                        <option value="21:00">21:00</option>
                        <option value="21:30">21:30</option>
                        <option value="22:00">22:00</option>
                        <option value="22:30">22:30</option>
                        <option value="23:00">23:00</option>
                        <option value="23:30">23:30</option>
                        <option value="00:00">0:00</option>
                        <option value="00:30">0:30</option>
                        <option value="01:00">1:00</option>
                        <option value="01:30">1:30</option>
                        <option value="02:00">2:00</option>
                    </select>
                </div>
            </div>

            <div class="section-title">Today's Focus</div>
            <div class="active-quests-container" id="activeQuestsContainer"></div>
            <button class="btn-main" id="reflectionBtn" onclick="showReflection()">CHECK OUT â†’</button>
            <div id="reflectionNotice"
                style="display: none; margin-top: 12px; padding: 10px; background: rgba(201, 169, 98, 0.1); border: 1px solid var(--gold); border-radius: 8px; text-align: center; font-size: 12px; color: var(--navy);">
                â° æ¥­å‹™çµ‚ã‚ã‚Šã«æŒ¯ã‚Šè¿”ã‚Šã‚’ã—ã¦ãã ã•ã„<br>
                <span id="reflectionTimer" style="font-family: 'Montserrat', sans-serif; font-weight: 600;"></span>
            </div>
        </div>

        <!-- SCREEN 3: REFLECTION -->
        <div class="screen" id="screen-reflection">
            <div class="reflection-prompt">ä»Šæ—¥ã®3ã¤ã®Quest<br><span style="color: var(--gold);"
                    id="reflectionQuestTitles"></span><br>ã‚’æ„è­˜ã§ãã¾ã—ãŸã‹ï¼Ÿ<br><span
                    style="font-size: 13px; color: var(--text-gray);">â˜…ã§è©•ä¾¡ã—ã¦ãã ã•ã„</span></div>
            <div class="star-rating" id="starRating"><span class="star" data-value="1">â˜…</span><span class="star"
                    data-value="2">â˜…</span><span class="star" data-value="3">â˜…</span><span class="star"
                    data-value="4">â˜…</span><span class="star" data-value="5">â˜…</span></div>
            <textarea class="memo-input" id="memoInput" placeholder="ä»Šæ—¥ã®æ°—ã¥ãã‚„å­¦ã³ã‚’ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰"></textarea>
            <button class="btn-main" onclick="submitReflection()">COMPLETE</button>
        </div>

        <!-- SCREEN 4: COMPLETION -->
        <div class="screen" id="screen-completion">
            <div class="completion-icon">âœ¨</div>
            <div class="completion-message">Great Work!</div>
            <div class="completion-sub">ä»Šæ—¥ã‚‚MINDFULãªä¸€æ—¥ã‚’éã”ã—ã¾ã—ãŸã­ã€‚<br>ã“ã®ç©ã¿é‡ã­ãŒã‚ãªãŸã‚’æœªæ¥ã¸ã¨é‹ã³ã¾ã™ã€‚</div>

            <div class="token-earned-container" id="tokenEarnedContainer">
                <div class="token-earned-badge">
                    <div class="token-earned-icon">ğŸª™</div>
                    <div class="token-earned-amount" id="tokenEarnedAmount">+0</div>
                    <div class="token-earned-label">TOKEN EARNED</div>
                    <div class="token-breakdown" id="tokenBreakdown"></div>
                </div>
            </div>

            <button class="btn-main" onclick="resetApp()">NEXT DAY â†’</button>
            <button class="btn-secondary" onclick="showHistory()">VIEW HISTORY</button>
        </div>

        <!-- SCREEN 5: HISTORY -->
        <div class="screen" id="screen-history">
            <div class="section-title">My Mindful Log</div>
            <div id="historyList"></div>
            <button class="btn-secondary" onclick="showScreen('screen-morning')">BACK</button>
        </div>

        <!-- SCREEN 6: PROFILE VIEW -->
        <div class="screen" id="screen-profile">
            <div class="section-title">My Profile</div>
            <div class="register-card">
                <div style="text-align: center; margin-bottom: 20px;">
                    <!-- Profile Photo -->
                    <div style="position: relative; display: inline-block;">
                        <div id="profilePhotoContainer"
                            style="width: 100px; height: 100px; border-radius: 50%; background: var(--light-gray); border: 3px solid var(--gold); display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer; transition: all 0.2s;"
                            onclick="document.getElementById('photoInput').click()">
                            <img id="profilePhoto" src=""
                                style="width: 100%; height: 100%; object-fit: cover; display: none;">
                            <span id="profilePhotoPlaceholder" style="font-size: 40px;">ğŸ‘¤</span>
                        </div>
                        <div style="position: absolute; bottom: 0; right: 0; background: var(--gold); width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.2);"
                            onclick="document.getElementById('photoInput').click()">
                            <span style="font-size: 14px;">ğŸ“·</span>
                        </div>
                    </div>
                    <input type="file" id="photoInput" accept="image/*" style="display: none;"
                        onchange="handlePhotoUpload(event)">
                    <div style="font-size: 10px; color: var(--text-gray); margin-top: 8px;">ã‚¿ãƒƒãƒ—ã—ã¦å†™çœŸã‚’å¤‰æ›´</div>
                    <div style="font-family: 'Montserrat', sans-serif; font-size: 20px; font-weight: 600; color: var(--navy); margin-top: 12px;"
                        id="profileName">-</div>
                    <div style="font-size: 13px; color: var(--text-gray); margin-top: 5px;" id="profileBase">-</div>
                </div>

                <div
                    style="background: var(--gold-light); border: 1px solid var(--gold); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                    <div
                        style="font-family: 'Montserrat', sans-serif; font-size: 9px; color: var(--gold); letter-spacing: 0.15em; margin-bottom: 10px; font-weight: 600;">
                        ğŸ“Œ MY VISION</div>
                    <div style="font-size: 13px; color: var(--navy); margin-bottom: 12px;">
                        <strong style="color: var(--gold);">ğŸ¯ ä»Šå¹´ã®ç›®æ¨™</strong>
                        <div id="profileGoalsThisYear"
                            style="margin-top: 4px; color: var(--text-gray); line-height: 1.6;">-</div>
                    </div>
                    <div style="font-size: 13px; color: var(--navy);">
                        <strong style="color: var(--gold);">âœ¨ SVDã§å¶ãˆãŸã„ã‚­ãƒ£ãƒªã‚¢ã¾ãŸã¯å°†æ¥ã®å¤¢</strong>
                        <div id="profileGoalsFuture"
                            style="margin-top: 4px; color: var(--text-gray); line-height: 1.6;">-</div>
                    </div>
                    <button onclick="openGoalsEditor()"
                        style="margin-top: 12px; width: 100%; padding: 10px; background: var(--gold); color: var(--navy-dark); border: none; border-radius: 8px; font-family: 'Montserrat', sans-serif; font-weight: 600; font-size: 11px; letter-spacing: 0.05em; cursor: pointer;">âœï¸
                        ç›®æ¨™ãƒ»å¤¢ã‚’æ›´æ–°ã™ã‚‹</button>
                </div>

                <div
                    style="display: flex; align-items: center; justify-content: center; gap: 10px; padding: 12px; background: var(--light-gray); border-radius: 10px; margin-bottom: 20px;">
                    <span class="token-icon">ğŸª™</span>
                    <span
                        style="font-family: 'Montserrat', sans-serif; font-weight: 700; font-size: 24px; color: var(--gold);"
                        id="profileTokens">0</span>
                    <span
                        style="font-family: 'Montserrat', sans-serif; font-size: 11px; color: var(--text-gray);">TOKEN</span>
                </div>

                <button class="btn-main" onclick="confirmEditProfile()">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç·¨é›†ã™ã‚‹</button>
                <button class="btn-secondary" onclick="showScreen('screen-morning')">æˆ»ã‚‹</button>
            </div>
        </div>

        <!-- GOALS EDIT MODAL -->
        <div id="goalsEditModal"
            style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1000; padding: 20px; overflow-y: auto;">
            <div
                style="background: var(--white); border-radius: 16px; padding: 25px; max-width: 500px; margin: 20px auto;">
                <div
                    style="font-family: 'Montserrat', sans-serif; font-size: 18px; font-weight: 600; color: var(--navy); text-align: center; margin-bottom: 20px;">
                    ğŸ¯ MY VISION ã‚’æ›´æ–°
                </div>

                <div class="input-group" style="margin-bottom: 20px;">
                    <label class="input-label">ğŸ¯ ä»Šå¹´ã®ç›®æ¨™ï¼ˆ3ã¤ã¾ã§ï¼‰</label>
                    <input type="text" class="text-input" id="editGoalThisYear1" placeholder="ç›®æ¨™ 1"
                        style="margin-bottom: 8px;">
                    <input type="text" class="text-input" id="editGoalThisYear2" placeholder="ç›®æ¨™ 2ï¼ˆä»»æ„ï¼‰"
                        style="margin-bottom: 8px;">
                    <input type="text" class="text-input" id="editGoalThisYear3" placeholder="ç›®æ¨™ 3ï¼ˆä»»æ„ï¼‰">
                </div>

                <div class="input-group" style="margin-bottom: 25px;">
                    <label class="input-label">âœ¨ SVDã§å¶ãˆãŸã„ã‚­ãƒ£ãƒªã‚¢ã¾ãŸã¯å°†æ¥ã®å¤¢ï¼ˆ3ã¤ã¾ã§ï¼‰</label>
                    <input type="text" class="text-input" id="editGoalFuture1" placeholder="å¤¢ 1"
                        style="margin-bottom: 8px;">
                    <input type="text" class="text-input" id="editGoalFuture2" placeholder="å¤¢ 2ï¼ˆä»»æ„ï¼‰"
                        style="margin-bottom: 8px;">
                    <input type="text" class="text-input" id="editGoalFuture3" placeholder="å¤¢ 3ï¼ˆä»»æ„ï¼‰">
                </div>

                <button onclick="saveGoalsEdit()" class="btn-main" style="margin-top: 0;">ä¿å­˜ã™ã‚‹</button>
                <button onclick="closeGoalsEditor()" class="btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </main>

    <footer>SAPPORO VIEWTIFUL DINING â€” ORIGIN</footer>

    <nav>
        <div class="nav-item active" onclick="showScreen('screen-morning')">
            <div class="nav-icon">ğŸŒ…</div>
            <div>C/IN</div>
        </div>
        <div class="nav-item" onclick="showScreen('screen-active')">
            <div class="nav-icon">ğŸ¯</div>
            <div>STAY-C/O</div>
        </div>
        <div class="nav-item" onclick="showScreen('screen-history')">
            <div class="nav-icon">ğŸ“œ</div>
            <div>HISTORY</div>
        </div>
        <div class="nav-item" onclick="showProfile()">
            <div class="nav-icon">ğŸ‘¤</div>
            <div>PROFILE</div>
        </div>
    </nav>

    <div class="sending-overlay" id="sendingOverlay">
        <div class="spinner"></div>
        <div class="sending-text">SENDING DATA...</div>
    </div>

    <script>
        const SCRIPT_URLS = { moiwayama: 'https://script.google.com/macros/s/AKfycbxGL8p3a8-k7xnhz2jfmyq39fXplB0qGI55urinPg9tRBWmbmKEEWcqZNSpUxhs5K3T/exec', okurayama: 'https://script.google.com/macros/s/AKfycbxVVfr-XAgj4n-hOEobZ2wwbgk3QIKQk1T9qFSDsk7PdQ4J8cd5WGH-KA0K9z_x_Vip/exec', tvtower: 'https://script.google.com/macros/s/AKfycbxlj2-3R6HcTd5A45azVScgQDvUBSTGC8faWBXDRI_ck7kbCltTYKnkfaW6njZ88bsi/exec', akarenga: 'https://script.google.com/macros/s/AKfycbzHN2p9eYAFFxip_Wj6b0J_Qm9SIxjetvPJENTBIBiBwLuEPaej_iJC4AUghIJF1cwZZQ/exec' };
        const BASE_NAMES = { moiwayama: 'è—»å²©å±±', okurayama: 'å¤§å€‰å±±', tvtower: 'ãƒ†ãƒ¬ãƒ“å¡”', akarenga: 'èµ¤ã‚Œã‚“ãŒ' };

        const playbook = [
            { id: "001", titleEn: "MAGIC MOMENT CAPTURE", titleJp: "ãƒã‚¸ãƒƒã‚¯ãƒ»ãƒ¢ãƒ¼ãƒ¡ãƒ³ãƒˆãƒ»ã‚­ãƒ£ãƒ—ãƒãƒ£", action: "æ„Ÿå‹•çš„ãªç¬é–“ãŒç”Ÿã¾ã‚ŒãŸæ™‚ã€ã‚¤ãƒ³ã‚«ãƒ ã§ã€Œãƒã‚¸ãƒƒã‚¯ï¼ã€ã¨å…±æœ‰ã™ã‚‹ã€‚ãƒãƒ¼ãƒ å…¨å“¡ã§ãã®å–œã³ã‚’å‘³ã‚ãŠã†ã€‚" },
            { id: "002", titleEn: "FIRST SMILE", titleJp: "ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒ»ã‚¹ãƒã‚¤ãƒ«", action: "ã‚²ã‚¹ãƒˆã¨ç›®ãŒåˆã£ãŸç¬é–“ã€è‡ªåˆ†ã‹ã‚‰å…ˆã«ç¬‘é¡”ã‚’å±Šã‘ã‚‹ã€‚ãã®ä¸€ç¬ãŒã™ã¹ã¦ã®å§‹ã¾ã‚Šã€‚" },
            { id: "003", titleEn: "THE ENTRANCE ENERGY", titleJp: "ã‚¨ãƒ³ãƒˆãƒ©ãƒ³ã‚¹ãƒ»ã‚¨ãƒŠã‚¸ãƒ¼", action: "ãŠåº—ã«å…¥ã‚‹ç¬é–“ã€ã€Œä»Šæ—¥ã‚‚æœ€é«˜ã®ã‚·ãƒ§ãƒ¼ã‚’å±Šã‘ã‚‹ãã€ã¨å¿ƒã®ä¸­ã§å®£è¨€ã€‚ã‚¹ã‚¤ãƒƒãƒã‚’å…¥ã‚Œã‚ˆã†ã€‚" },
            { id: "006", titleEn: "THE FIRST 10 SECONDS", titleJp: "ã‚¶ãƒ»ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒ»ãƒ†ãƒ³", action: "ã‚²ã‚¹ãƒˆç€å¸­å¾Œã®æœ€åˆã®10ç§’ã§ã€å¿…ãšã€Œäºˆæƒ³å¤–ã®ãƒ—ãƒ©ã‚¹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€ã‚’ä¸€ã¤å…¥ã‚Œã‚‹ã€‚" },
            { id: "010", titleEn: "TEAM HIGH FIVE", titleJp: "ãƒãƒ¼ãƒ ãƒ»ãƒã‚¤ãƒ•ã‚¡ã‚¤ãƒ–", action: "ä»²é–“ã®ãƒŠã‚¤ã‚¹ãƒ—ãƒ¬ãƒ¼ã‚’è¦‹ãŸã‚‰ã€å¿ƒã®ä¸­ã§ã€ŒãƒŠã‚¤ã‚¹ï¼ã€ã¨ç§°ãˆã‚‹ã€‚å¸°ã‚Šéš›ã«ãã®ä¸€è¨€ã‚’ä¼ãˆã‚ˆã†ã€‚" },
            { id: "019", titleEn: "WARM FAREWELL", titleJp: "ã‚¦ã‚©ãƒ¼ãƒ ãƒ»ãƒ•ã‚§ã‚¢ã‚¦ã‚§ãƒ«", action: "ãŠè¦‹é€ã‚Šã¯æœ€é«˜ã®ç¬‘é¡”ã§ã€‚ã€Œã¾ãŸä¼šã„ãŸã„ã€ã¨æ€ã£ã¦ã‚‚ã‚‰ãˆã‚‹ã€å¿ƒã‹ã‚‰ã®ã€Œã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€ã‚’ã€‚" },
            { id: "031", titleEn: "THE HUDDLE", titleJp: "ã‚¶ãƒ»ãƒãƒ‰ãƒ«", action: "ãƒ”ãƒ¼ã‚¯ã‚¿ã‚¤ãƒ ç›´å‰ã€ãƒãƒ¼ãƒ ã§é¡”ã‚’åˆã‚ã›ã¦ã€Œä»Šæ—¥ã‚‚è¡Œã“ã†ï¼ã€ã®ä¸€å£°ã€‚æ°—æŒã¡ã‚’ä¸€ã¤ã«ã€‚" },
            { id: "035", titleEn: "THE SILENT PASS", titleJp: "ã‚µã‚¤ãƒ¬ãƒ³ãƒˆãƒ»ãƒ‘ã‚¹", action: "ä»²é–“ã®è¦–ç·šã®å…ˆã‚’èª­ã¿ã€é ¼ã¾ã‚Œã‚‹å‰ã«ã‚µãƒãƒ¼ãƒˆã€‚è¨€è‘‰ãªã—ã§é€šã˜ã‚‹é€£æºã¯æœ€é«˜ã®ãƒãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã€‚" },
            { id: "050", titleEn: "SMILING THROUGH CHAOS", titleJp: "ã‚¹ãƒã‚¤ãƒªãƒ³ã‚°ãƒ»ã‚¹ãƒ«ãƒ¼ãƒ»ã‚«ã‚ªã‚¹", action: "ã©ã‚Œã ã‘å¿™ã—ãã¦ã‚‚ã€ã‚²ã‚¹ãƒˆã®å‰ã§ã¯æ¶¼ã—ã„ç¬‘é¡”ã€‚ãƒ—ãƒ­ã®æ¼”æŠ€åŠ›ã‚’ç£¨ã“ã†ã€‚" },
            { id: "100", titleEn: "ONE PURPOSE", titleJp: "ãƒ¯ãƒ³ãƒ»ãƒ‘ãƒ¼ãƒ‘ã‚¹", action: "ã€Œãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã®ä»•äº‹ãŒå­ã©ã‚‚ãŸã¡ã®æ†§ã‚Œã«ãªã‚‹ã€ã€‚ãã®æœªæ¥ã‚’ã€ä»Šæ—¥ã®è‡ªåˆ†ãŒå‰µã£ã¦ã„ã‚‹ã€‚" }
        ];


        let currentQuests = [];
        let currentRating = 0;
        let selectedBase = null;
        let todayBase = null; // ãã®æ—¥ã®å‹¤å‹™å…ˆ
        const checkFields = ['condition', 'temp', 'fatigue', 'nausea', 'nails', 'hands', 'uniform'];
        const mindFields = ['mind_enjoy', 'mind_morning', 'mind_consult'];
        let checks = {};
        let mindChecks = {};
        let shiftTimes = { start: '', end: '' };

        function setShiftTime(type, time) {
            shiftTimes[type] = time;
            const container = type === 'start' ? document.getElementById('shiftStartBtns') : document.getElementById('shiftEndBtns');
            container.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        function init() {
            checkFields.forEach(f => checks[f] = null);
            mindFields.forEach(f => mindChecks[f] = null);
            loadHistory();
            setupStarRating();
            const profile = JSON.parse(localStorage.getItem('mindful_profile') || 'null');
            if (profile) {
                showUserBadge(profile);
                updateTokenDisplay();
                showGoalsDisplay(profile);
                checkActiveSession();
                showScreen('screen-morning');
            }
            else { showScreen('screen-register'); }
        }


        function selectBase(el) {
            document.querySelectorAll('.base-option').forEach(o => o.classList.remove('selected'));
            el.classList.add('selected');
            selectedBase = el.dataset.base;
            validateRegistration();
        }

        function validateRegistration() {
            const name = document.getElementById('inputName').value.trim();
            document.getElementById('registerBtn').disabled = !(name && selectedBase);
        }
        document.getElementById('inputName').addEventListener('input', validateRegistration);

        function register() {
            const name = document.getElementById('inputName').value.trim();
            // ç›®æ¨™ã¨å¤¢ã‚’é…åˆ—ã¨ã—ã¦åé›†ï¼ˆç©ºã§ãªã„ã‚‚ã®ã®ã¿ï¼‰
            const goalsThisYear = [
                document.getElementById('inputGoalThisYear1').value.trim(),
                document.getElementById('inputGoalThisYear2').value.trim(),
                document.getElementById('inputGoalThisYear3').value.trim()
            ].filter(g => g !== '');
            const goalsFuture = [
                document.getElementById('inputGoalFuture1').value.trim(),
                document.getElementById('inputGoalFuture2').value.trim(),
                document.getElementById('inputGoalFuture3').value.trim()
            ].filter(g => g !== '');
            if (name && selectedBase) {
                const profile = { name, base: selectedBase, goalsThisYear, goalsFuture };
                localStorage.setItem('mindful_profile', JSON.stringify(profile));
                showUserBadge(profile);
                showGoalsDisplay(profile);
                showScreen('screen-morning');
            }
        }

        function showUserBadge(profile) {
            const badge = document.getElementById('userBadge');
            if (todayBase && todayBase !== profile.base) {
                badge.innerHTML = `${profile.name} <span style="font-size: 10px; opacity: 0.7;">ğŸ ${BASE_NAMES[profile.base]}</span> â†’ <span style="color: var(--gold);">ğŸ“${BASE_NAMES[todayBase]}</span>`;
            } else if (todayBase) {
                badge.textContent = `${profile.name} @ ${BASE_NAMES[todayBase]}`;
            } else {
                badge.textContent = `${profile.name} @ ${BASE_NAMES[profile.base]}`;
            }
            badge.style.display = 'inline-block';
        }

        function selectTodayBase(el) {
            document.querySelectorAll('.base-option.today-base').forEach(o => o.classList.remove('selected'));
            el.classList.add('selected');
            todayBase = el.dataset.base;
            localStorage.setItem('mindful_today_base', todayBase);
            document.getElementById('todayLocationStatus').innerHTML = `<span style="color: var(--gold); font-weight: 600;">âœ“ ä»Šæ—¥ã¯ ${BASE_NAMES[todayBase]} ã§å‹¤å‹™ã—ã¾ã™</span>`;
            const profile = JSON.parse(localStorage.getItem('mindful_profile'));
            if (profile) showUserBadge(profile);
            validateHealthCheck();
        }

        function showProfile() {
            const profile = JSON.parse(localStorage.getItem('mindful_profile') || 'null');
            if (!profile) {
                showScreen('screen-register');
                return;
            }

            // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»é¢ã«æƒ…å ±ã‚’è¡¨ç¤º
            document.getElementById('profileName').textContent = profile.name;
            document.getElementById('profileBase').textContent = BASE_NAMES[profile.base] || profile.base;

            // ç›®æ¨™ã¨å¤¢ã‚’è¡¨ç¤ºï¼ˆé…åˆ—å½¢å¼å¯¾å¿œï¼‰
            const goalsThisYear = profile.goalsThisYear || (profile.goalThisYear ? [profile.goalThisYear] : []);
            const goalsFuture = profile.goalsFuture || (profile.goalFuture ? [profile.goalFuture] : []);

            document.getElementById('profileGoalsThisYear').innerHTML = goalsThisYear.length > 0
                ? goalsThisYear.map((g, i) => `${i + 1}. ${g}`).join('<br>')
                : 'æœªè¨­å®š';
            document.getElementById('profileGoalsFuture').innerHTML = goalsFuture.length > 0
                ? goalsFuture.map((g, i) => `${i + 1}. ${g}`).join('<br>')
                : 'æœªè¨­å®š';

            document.getElementById('profileTokens').textContent = getTokenBalance();

            // å†™çœŸã‚’èª­ã¿è¾¼ã¿
            loadProfilePhoto();

            showScreen('screen-profile');
        }

        function confirmEditProfile() {
            if (confirm('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç·¨é›†ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆç¾åœ¨ã®ç™»éŒ²æƒ…å ±ã¯å‰Šé™¤ã•ã‚Œã¾ã™ï¼‰')) {
                localStorage.removeItem('mindful_profile');
                localStorage.removeItem('mindful_checkin_time');
                localStorage.removeItem('mindful_photo');
                selectedBase = null;
                document.querySelectorAll('.base-option').forEach(o => o.classList.remove('selected'));
                document.getElementById('inputName').value = '';
                document.getElementById('inputGoalThisYear1').value = '';
                document.getElementById('inputGoalThisYear2').value = '';
                document.getElementById('inputGoalThisYear3').value = '';
                document.getElementById('inputGoalFuture1').value = '';
                document.getElementById('inputGoalFuture2').value = '';
                document.getElementById('inputGoalFuture3').value = '';
                document.getElementById('userBadge').style.display = 'none';
                document.getElementById('goalsDisplay').style.display = 'none';
                showScreen('screen-register');
            }
        }

        // Legacy function - redirects to showProfile
        function editProfile() {
            showProfile();
        }

        // ç›®æ¨™ãƒ»å¤¢ã®ç·¨é›†æ©Ÿèƒ½
        function openGoalsEditor() {
            const profile = JSON.parse(localStorage.getItem('mindful_profile') || 'null');
            if (!profile) return;

            // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ç·¨é›†ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«èª­ã¿è¾¼ã¿ï¼ˆé…åˆ—å½¢å¼å¯¾å¿œï¼‰
            const goalsThisYear = profile.goalsThisYear || (profile.goalThisYear ? [profile.goalThisYear] : []);
            const goalsFuture = profile.goalsFuture || (profile.goalFuture ? [profile.goalFuture] : []);

            document.getElementById('editGoalThisYear1').value = goalsThisYear[0] || '';
            document.getElementById('editGoalThisYear2').value = goalsThisYear[1] || '';
            document.getElementById('editGoalThisYear3').value = goalsThisYear[2] || '';
            document.getElementById('editGoalFuture1').value = goalsFuture[0] || '';
            document.getElementById('editGoalFuture2').value = goalsFuture[1] || '';
            document.getElementById('editGoalFuture3').value = goalsFuture[2] || '';

            document.getElementById('goalsEditModal').style.display = 'block';
        }

        function closeGoalsEditor() {
            document.getElementById('goalsEditModal').style.display = 'none';
        }

        function saveGoalsEdit() {
            const profile = JSON.parse(localStorage.getItem('mindful_profile') || 'null');
            if (!profile) return;

            // ç·¨é›†ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰é…åˆ—ã‚’åé›†ï¼ˆç©ºã§ãªã„ã‚‚ã®ã®ã¿ï¼‰
            profile.goalsThisYear = [
                document.getElementById('editGoalThisYear1').value.trim(),
                document.getElementById('editGoalThisYear2').value.trim(),
                document.getElementById('editGoalThisYear3').value.trim()
            ].filter(g => g !== '');
            profile.goalsFuture = [
                document.getElementById('editGoalFuture1').value.trim(),
                document.getElementById('editGoalFuture2').value.trim(),
                document.getElementById('editGoalFuture3').value.trim()
            ].filter(g => g !== '');

            // å¤ã„å½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
            delete profile.goalThisYear;
            delete profile.goalFuture;

            localStorage.setItem('mindful_profile', JSON.stringify(profile));

            // è¡¨ç¤ºã‚’æ›´æ–°
            showGoalsDisplay(profile);
            showProfile();
            closeGoalsEditor();
        }

        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 2 * 1024 * 1024) {
                alert('ç”»åƒã‚µã‚¤ã‚ºã¯2MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                const img = new Image();
                img.onload = function () {
                    const canvas = document.createElement('canvas');
                    const maxSize = 200;
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > maxSize) { height *= maxSize / width; width = maxSize; }
                    } else {
                        if (height > maxSize) { width *= maxSize / height; height = maxSize; }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                    localStorage.setItem('mindful_photo', dataUrl);
                    loadProfilePhoto();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function loadProfilePhoto() {
            const photoData = localStorage.getItem('mindful_photo');
            const photoEl = document.getElementById('profilePhoto');
            const placeholderEl = document.getElementById('profilePhotoPlaceholder');

            if (photoData && photoEl && placeholderEl) {
                photoEl.src = photoData;
                photoEl.style.display = 'block';
                placeholderEl.style.display = 'none';
            } else if (photoEl && placeholderEl) {
                photoEl.style.display = 'none';
                placeholderEl.style.display = 'block';
            }
        }

        function showGoalsDisplay(profile) {
            const container = document.getElementById('goalsDisplay');
            // é…åˆ—å½¢å¼ã®ç›®æ¨™ãƒ»å¤¢ã‚’å–å¾—ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚å¤ã„å½¢å¼ã‚‚å¯¾å¿œï¼‰
            const goalsThisYear = profile.goalsThisYear || (profile.goalThisYear ? [profile.goalThisYear] : []);
            const goalsFuture = profile.goalsFuture || (profile.goalFuture ? [profile.goalFuture] : []);

            if (goalsThisYear.length > 0 || goalsFuture.length > 0) {
                container.style.display = 'block';

                // ç•ªå·ä»˜ããƒªã‚¹ãƒˆã§è¡¨ç¤º
                document.getElementById('goalsThisYearList').innerHTML = goalsThisYear.length > 0
                    ? goalsThisYear.map((g, i) => `${i + 1}. ${g}`).join('<br>')
                    : '-';
                document.getElementById('goalsFutureList').innerHTML = goalsFuture.length > 0
                    ? goalsFuture.map((g, i) => `${i + 1}. ${g}`).join('<br>')
                    : '-';

                // MY VISIONã«å†™çœŸã‚’è¡¨ç¤º
                const photoData = localStorage.getItem('mindful_photo');
                const goalsPhoto = document.getElementById('goalsPhoto');
                const goalsPhotoPlaceholder = document.getElementById('goalsPhotoPlaceholder');
                if (photoData && goalsPhoto && goalsPhotoPlaceholder) {
                    goalsPhoto.src = photoData;
                    goalsPhoto.style.display = 'block';
                    goalsPhotoPlaceholder.style.display = 'none';
                } else if (goalsPhoto && goalsPhotoPlaceholder) {
                    goalsPhoto.style.display = 'none';
                    goalsPhotoPlaceholder.style.display = 'block';
                }
            } else {
                container.style.display = 'none';
            }
        }

        function checkActiveSession() {
            const checkinTime = localStorage.getItem('mindful_checkin_time');
            if (checkinTime) {
                const savedQuests = JSON.parse(localStorage.getItem('mindful_active_quests') || '[]');
                if (savedQuests.length > 0) {
                    currentQuests = savedQuests;
                    const container = document.getElementById('activeQuestsContainer');
                    container.innerHTML = currentQuests.map((q, i) => `
                        <div class="active-quest-card">
                            <div class="quest-label">QUEST ${i + 1}</div>
                            <div class="quest-number">#${q.id}</div>
                            <div class="quest-title">${q.titleEn}</div>
                            <div class="quest-subtitle">${q.titleJp}</div>
                            <div class="quest-philosophy">${q.action}</div>
                        </div>
                    `).join('');
                    updateReflectionButton();
                    showScreen('screen-active');
                }
            }
        }

        function updateReflectionButton() {
            const checkinTime = localStorage.getItem('mindful_checkin_time');
            const reflectionBtn = document.getElementById('reflectionBtn');
            const reflectionNotice = document.getElementById('reflectionNotice');
            const reflectionTimer = document.getElementById('reflectionTimer');

            if (!checkinTime) {
                reflectionBtn.disabled = false;
                reflectionNotice.style.display = 'none';
                return;
            }

            const checkinDate = new Date(checkinTime);
            const now = new Date();
            const diffMs = now - checkinDate;
            const diffHours = diffMs / (1000 * 60 * 60);
            const MIN_HOURS = 3;

            if (diffHours >= MIN_HOURS) {
                reflectionBtn.disabled = false;
                reflectionBtn.style.opacity = '1';
                reflectionNotice.style.display = 'none';
            } else {
                reflectionBtn.disabled = true;
                reflectionBtn.style.opacity = '0.5';
                reflectionNotice.style.display = 'block';
                const remainingMs = (MIN_HOURS * 60 * 60 * 1000) - diffMs;
                const remainingHours = Math.floor(remainingMs / (1000 * 60 * 60));
                const remainingMins = Math.floor((remainingMs % (1000 * 60 * 60)) / (1000 * 60));
                reflectionTimer.textContent = `ã‚ã¨ ${remainingHours}æ™‚é–“ ${remainingMins}åˆ†`;

                // Update every minute
                setTimeout(updateReflectionButton, 60000);
            }
        }

        function setCheck(btn, value) {
            const field = btn.dataset.field;
            checks[field] = value;
            btn.parentElement.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            validateHealth();
        }

        function validateHealth() {
            const statusEl = document.getElementById('healthStatus');
            const drawArea = document.getElementById('drawArea');
            const card = document.getElementById('healthCheckCard');
            const allAnswered = checkFields.every(f => checks[f] !== null);
            const allOk = checkFields.every(f => checks[f] === 'ok');

            if (!allAnswered) {
                statusEl.className = 'health-status incomplete'; statusEl.textContent = 'ã™ã¹ã¦ã®é …ç›®ã‚’ç¢ºèªã—ã¦ãã ã•ã„';
                card.classList.remove('complete');
            } else if (!allOk) {
                statusEl.className = 'health-status ng'; statusEl.textContent = 'âš ï¸ è¦ç¢ºèªï¼šç®¡ç†è€…ã«å ±å‘Šã—ã¦ãã ã•ã„';
                card.classList.remove('complete');
            } else {
                statusEl.className = 'health-status ok'; statusEl.textContent = 'âœ“ ç¢ºèªå®Œäº†';
                card.classList.add('complete');
            }
            updateDrawArea();
        }

        function setMindCheck(btn, value) {
            const field = btn.dataset.field;
            mindChecks[field] = value;
            btn.parentElement.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            validateMind();
        }

        function validateMind() {
            const statusEl = document.getElementById('mindStatus');
            const card = document.getElementById('mindCheckCard');
            const allAnswered = mindFields.every(f => mindChecks[f] !== null);

            if (!allAnswered) {
                statusEl.className = 'health-status incomplete'; statusEl.textContent = 'å¿ƒã®çŠ¶æ…‹ã‚‚ç¢ºèªã—ã¦ãã ã•ã„';
                card.classList.remove('complete');
            } else {
                statusEl.className = 'health-status ok'; statusEl.textContent = 'âœ“ å¿ƒã®ç¢ºèªå®Œäº†';
                card.classList.add('complete');
                // è¦ãƒ•ã‚©ãƒ­ãƒ¼ã®å ´åˆã®ã¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¤‰æ›´
                if (mindChecks.mind_consult === 'urgent' || mindChecks.mind_consult === 'sometime') {
                    statusEl.textContent = 'ğŸ’¬ ã„ã¤ã§ã‚‚ç›¸è«‡ã—ã¦ã­';
                }
            }
            updateDrawArea();
        }

        function updateDrawArea() {
            const drawArea = document.getElementById('drawArea');
            const healthOk = checkFields.every(f => checks[f] === 'ok');
            const mindAnswered = mindFields.every(f => mindChecks[f] !== null);
            const locationSelected = todayBase !== null;

            if (healthOk && mindAnswered && locationSelected) {
                drawArea.classList.remove('disabled');
                drawArea.querySelector('.draw-hint').textContent = 'ã‚¿ãƒƒãƒ—ã—ã¦3æšã®ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã';
            } else if (!locationSelected) {
                drawArea.classList.add('disabled');
                drawArea.querySelector('.draw-hint').textContent = 'ğŸ“ ã¾ãšä»Šæ—¥ã®å‹¤å‹™å…ˆã‚’é¸æŠã—ã¦ãã ã•ã„';
            } else {
                drawArea.classList.add('disabled');
                drawArea.querySelector('.draw-hint').textContent = 'å…¨é …ç›®ã‚’ç¢ºèªã—ã¦ã‹ã‚‰ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã‘ã¾ã™';
            }
        }

        function drawQuests() {
            if (document.getElementById('drawArea').classList.contains('disabled')) return;

            // Draw 3 random quests
            const shuffled = [...playbook].sort(() => Math.random() - 0.5);
            currentQuests = shuffled.slice(0, 3);

            document.getElementById('drawArea').style.display = 'none';
            const container = document.getElementById('questCardsContainer');
            container.innerHTML = currentQuests.map((q, i) => `
            <div class="quest-card revealed" style="animation-delay: ${i * 0.15}s;">
                <div class="quest-label">QUEST ${i + 1}</div>
                <div class="quest-number">#${q.id}</div>
                <div class="quest-title">${q.titleEn}</div>
                <div class="quest-subtitle">${q.titleJp}</div>
                <div class="quest-philosophy">${q.action}</div>
            </div>
        `).join('');
            document.getElementById('startBtn').style.display = 'block';
        }

        function startDay() {
            // Save check-in time and quests for session persistence
            localStorage.setItem('mindful_checkin_time', new Date().toISOString());
            localStorage.setItem('mindful_active_quests', JSON.stringify(currentQuests));

            const container = document.getElementById('activeQuestsContainer');
            container.innerHTML = currentQuests.map((q, i) => `
            <div class="active-quest-card">
                <div class="quest-label">QUEST ${i + 1}</div>
                <div class="quest-number">#${q.id}</div>
                <div class="quest-title">${q.titleEn}</div>
                <div class="quest-subtitle">${q.titleJp}</div>
                <div class="quest-philosophy">${q.action}</div>
            </div>
        `).join('');
            sendToSheets('healthcheck');
            updateReflectionButton();
            showScreen('screen-active');
        }

        function showReflection() {
            document.getElementById('reflectionQuestTitles').innerHTML = currentQuests.map(q => q.titleEn).join('<br>');
            showScreen('screen-reflection');
        }

        function setupStarRating() {
            document.querySelectorAll('.star').forEach(star => {
                star.addEventListener('click', () => {
                    currentRating = parseInt(star.dataset.value);
                    document.querySelectorAll('.star').forEach((s, i) => s.classList.toggle('active', i < currentRating));
                });
            });
        }

        function submitReflection() {
            const memo = document.getElementById('memoInput').value;
            const today = new Date().toISOString().split('T')[0];
            const history = JSON.parse(localStorage.getItem('mindful_history') || '[]');
            history.unshift({ date: today, quests: currentQuests.map(q => ({ id: q.id, title: q.titleEn })), rating: currentRating, memo });
            localStorage.setItem('mindful_history', JSON.stringify(history.slice(0, 30)));

            // Token reward calculation
            const tokenReward = calculateTokenReward(currentRating, memo);
            addTokens(tokenReward.total);
            displayTokenReward(tokenReward);

            sendToSheets('reflection', tokenReward);
            showScreen('screen-completion');
        }

        // TOKEN SYSTEM FUNCTIONS
        function getTokenBalance() {
            return parseInt(localStorage.getItem('mindful_tokens') || '0');
        }

        function addTokens(amount) {
            const current = getTokenBalance();
            const newBalance = current + amount;
            localStorage.setItem('mindful_tokens', newBalance.toString());
            updateTokenDisplay();
            return newBalance;
        }

        function updateTokenDisplay() {
            const balance = getTokenBalance();
            const display = document.getElementById('tokenDisplay');
            const balanceEl = document.getElementById('tokenBalance');
            if (display && balanceEl) {
                display.style.display = 'inline-flex';
                balanceEl.textContent = balance;
            }
        }

        function calculateTokenReward(rating, memo) {
            const breakdown = [];
            let total = 0;

            // Base reward for completion
            total += 10;
            breakdown.push({ label: 'æŒ¯ã‚Šè¿”ã‚Šå®Œäº†', amount: 10 });

            // Rating bonus
            if (rating === 5) {
                total += 5;
                breakdown.push({ label: 'â˜…5è©•ä¾¡ãƒœãƒ¼ãƒŠã‚¹', amount: 5 });
            } else if (rating >= 4) {
                total += 2;
                breakdown.push({ label: 'â˜…4è©•ä¾¡ãƒœãƒ¼ãƒŠã‚¹', amount: 2 });
            }

            // Memo bonus
            if (memo && memo.trim().length > 0) {
                total += 3;
                breakdown.push({ label: 'ãƒ¡ãƒ¢è¨˜å…¥ãƒœãƒ¼ãƒŠã‚¹', amount: 3 });
            }

            return { total, breakdown };
        }

        function displayTokenReward(reward) {
            const amountEl = document.getElementById('tokenEarnedAmount');
            const breakdownEl = document.getElementById('tokenBreakdown');

            if (amountEl) {
                amountEl.textContent = '+' + reward.total;
            }

            if (breakdownEl) {
                breakdownEl.innerHTML = reward.breakdown.map(item =>
                    `<div class="token-breakdown-item"><span>${item.label}</span><span>+${item.amount}</span></div>`
                ).join('');
            }
        }

        async function sendToSheets(type, tokenData = null) {
            const profile = JSON.parse(localStorage.getItem('mindful_profile'));
            if (!profile) return;
            // ä»Šæ—¥ã®å‹¤å‹™å…ˆãŒã‚ã‚Œã°ãã¡ã‚‰ã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°æ‰€å±æ‹ ç‚¹
            const targetBase = todayBase || profile.base;
            const url = SCRIPT_URLS[targetBase];
            if (!url || url.startsWith('YOUR_')) { console.log('Sheets URL not configured'); return; }
            document.getElementById('sendingOverlay').classList.add('active');

            const payload = {
                type,
                timestamp: new Date().toISOString(),
                name: profile.name,
                homeBase: profile.base,
                todayBase: todayBase || profile.base,
                base: todayBase || profile.base, // å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚
                shiftStart: shiftTimes.start,
                shiftEnd: shiftTimes.end,
                checks,
                mindChecks,
                quests: currentQuests.map(q => ({ id: q.id, title: q.titleEn })),
                rating: currentRating,
                memo: document.getElementById('memoInput')?.value || ''
            };

            // ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±ã‚’è¿½åŠ 
            if (tokenData) {
                payload.tokenEarned = tokenData.total;
                payload.tokenBreakdown = tokenData.breakdown.map(b => `${b.label}:+${b.amount}`).join(', ');
            }

            try { await fetch(url, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(payload) }); } catch (e) { console.error('Failed:', e); }
            setTimeout(() => { document.getElementById('sendingOverlay').classList.remove('active'); }, 800);
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('mindful_history') || '[]');
            const container = document.getElementById('historyList');
            container.innerHTML = history.length === 0 ? '<p style="color: var(--text-gray); text-align: center; font-size: 12px;">No history yet.</p>' : history.map(item => `
            <div class="history-item">
                <div>
                    <div class="history-date">${item.date}</div>
                    <div class="history-quest">${item.quests ? item.quests.map(q => '#' + q.id).join(', ') : '#' + item.questId}</div>
                </div>
                <div class="history-stars">${'â˜…'.repeat(item.rating)}${'â˜†'.repeat(5 - item.rating)}</div>
            </div>
        `).join('');
        }

        function showHistory() { loadHistory(); showScreen('screen-history'); }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach((n, i) => {
                n.classList.toggle('active',
                    (screenId === 'screen-morning' && i === 0) ||
                    (screenId === 'screen-active' && i === 1) ||
                    (screenId === 'screen-history' && i === 2) ||
                    (screenId === 'screen-profile' && i === 3)
                );
            });
        }

        function resetApp() {
            // Clear session data
            localStorage.removeItem('mindful_checkin_time');
            localStorage.removeItem('mindful_active_quests');
            localStorage.removeItem('mindful_today_base'); // Clear today's work location

            currentRating = 0; currentQuests = [];
            todayBase = null; // Reset today's work location
            checkFields.forEach(f => checks[f] = null);
            mindFields.forEach(f => mindChecks[f] = null);
            document.getElementById('memoInput').value = '';
            document.querySelectorAll('.star').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('selected'));
            document.querySelectorAll('.base-option.today-base').forEach(o => o.classList.remove('selected')); // Reset location selector
            document.getElementById('todayLocationStatus').innerHTML = '<span style="color: var(--text-gray);">å‹¤å‹™å…ˆã‚’é¸æŠã—ã¦ãã ã•ã„</span>';
            document.getElementById('healthStatus').className = 'health-status incomplete';
            document.getElementById('healthStatus').textContent = 'ã™ã¹ã¦ã®é …ç›®ã‚’ç¢ºèªã—ã¦ãã ã•ã„';
            document.getElementById('healthCheckCard').classList.remove('complete');
            document.getElementById('mindStatus').className = 'health-status incomplete';
            document.getElementById('mindStatus').textContent = 'å¿ƒã®çŠ¶æ…‹ã‚‚ç¢ºèªã—ã¦ãã ã•ã„';
            document.getElementById('mindCheckCard').classList.remove('complete');
            document.getElementById('drawArea').style.display = 'block';
            document.getElementById('drawArea').classList.add('disabled');
            document.getElementById('drawArea').querySelector('.draw-hint').textContent = 'ğŸ“ ã¾ãšä»Šæ—¥ã®å‹¤å‹™å…ˆã‚’é¸æŠã—ã¦ãã ã•ã„';
            document.getElementById('questCardsContainer').innerHTML = '';
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('reflectionNotice').style.display = 'none';
            // Update badge to show only home base
            const profile = JSON.parse(localStorage.getItem('mindful_profile'));
            if (profile) showUserBadge(profile);
            showScreen('screen-morning');
        }

        init();
    </script>
</body>

</html>