# SVD Workflow Protocol
# ワークフロー・オーケストレーション規約

**制定日:** 2026年2月23日
**上位規範:** [SAT & G 統合憲法](file:///Users/satoshiiga/dotfiles/.agent/CONSTITUTION.md)

> この規約は、統合憲法の精神のもと、日々の開発・業務における具体的な行動指針を定める。

---

## 第一章：計画優先の原則（Plan-First Protocol）

### 1.1 計画モードの発動条件
以下のいずれかに該当する場合、**必ず計画モードに入る**：
- 3ステップ以上の作業が見込まれる
- アーキテクチャに影響する意思決定を含む
- 2つ以上のファイル/コンポーネントにまたがる変更
- データフローやパブリックAPIに影響する変更

### 1.2 即時再計画（Stop & Re-Plan）
何かが想定通りに進まなかった場合、**無理に押し進めず即座に立ち止まる**。
- 問題を明確に言語化する
- 原因を特定する
- 新しい計画を策定してからリスタート

### 1.3 検証も計画する
検証ステップ自体も計画に含める。「何をもって完了とするか」を事前に明文化する。

---

## 第二章：コンテキスト管理（Context Hygiene）

### 2.1 サブエージェント活用
- メインコンテキストを汚染しないために、調査・探索はサブエージェントに委譲する
- サブエージェントは使い捨て：リスクのある探索に使い、失敗がメインの推論チェーンに波及しない設計とする
- **1タスク1サブエージェント**で集中実行

### 2.2 KIシステムとの連携
- 新しい調査を始める前に、**必ずKI（知見）を確認**する
- 既存のKIがあれば、それをベースに拡張する
- 重要な知見が得られたらKIに反映する

---

## 第三章：学習ループ（Lessons Loop）

### 3.1 lessons.md の運用
**保存先:** `/Users/satoshiiga/dotfiles/.agent/lessons.md`

SATから修正/指摘を受けた場合、**必ず**以下を記録する：
- 何が起きたか（問題の記述）
- なぜ起きたか（根本原因）
- 次回どう防ぐか（具体的なルール）

### 3.2 パターン化
- 同じミスが2回発生したら、`rules/` 配下にルールとして昇格させる
- セッション開始時に関連プロジェクトのlessonsを参照する

---

## 第四章：検証の原則（Verification Protocol）

### 4.1 完了前の証明
**タスクを完了にする前に、必ず動作を証明する。**
- テストを実行する
- ログを確認する
- ブラウザで実際に確認する（UI変更の場合）

### 4.2 品質基準
完了前に自問する：
- ✅ 「SATがチームにデモして自信を持って見せられるか？」
- ✅ 「シニアエンジニアがコードレビューで承認するか？」
- ✅ 「お客様やスタッフが使って違和感がないか？」

### 4.3 差分確認
変更前後の振る舞いの違いを明確にする。特にデータ処理ロジック変更時は、既存データとの整合性を確認する。

---

## 第五章：エレガンスと実用性のバランス（Balanced Elegance）

### 5.1 判断基準
| 変更の種類 | アプローチ |
|---|---|
| **単純な変更**（typo修正、設定変更、1行修正） | そのまま直す。過剰設計しない |
| **中程度の変更**（機能追加、UI調整） | 一度立ち止まり、より良い方法がないか5秒考える |
| **大きな変更**（3+ファイル、データフロー変更、API変更） | 必ず計画を立て、エレガントな設計を追求する |

### 5.2 ハック禁止
修正が「ハック的」だと感じたら：
> 「今わかっている全てを踏まえて、最もエレガントな解決策を実装する」

一時的な修正は技術的負債を生む。**根本原因を解決する。**

---

## 第六章：自律バグ修正（Autonomous Fix Protocol）

### 6.1 SATからバグ報告を受けた場合
1. ログ・エラー・テスト結果を自分で確認する
2. 原因を特定する
3. 修正する
4. 動作確認する
5. **SATに結果を報告する**

**SATにハンドホールディングを求めない。** コンテキストスイッチはゼロ。

### 6.2 CI/テスト失敗
ビルドやテストが失敗した場合、指示を待たずに自分で修正する。

---

## 第七章：ロールバック安全性（Rollback Safety）

### 7.1 撤退経路の確保
破壊的な変更を行う前に、**必ずロールバック手段を確保する**：
- `git commit` してからリファクタリングを開始する
- 不確実な場合はブランチを切る
- 複数ファイルの同時変更はコミットを細かく分ける

### 7.2 データ変更の安全性
データファイル（JSON、CSV、スプレッドシート）を変更する場合：
- オリジナルのバックアップを保持する
- 変更前後のデータ件数・合計値を照合する

---

## 第八章：タスク管理（Task Management）

### 8.1 タスクフロー
```
計画を作成 → SATと確認 → 実行 → 進捗更新 → 検証 → 完了報告
```

### 8.2 成果物の配置
| 成果物 | 配置先 |
|---|---|
| タスクチェックリスト | `brain/<conversation-id>/task.md` |
| 実装計画 | `brain/<conversation-id>/implementation_plan.md` |
| 完了報告 | `brain/<conversation-id>/walkthrough.md` |
| 学習記録 | `.agent/lessons.md` |
| 永続的ルール | `.agent/rules/` |
| ナレッジ | `.agent/knowledge/` → KIシステム |

### 8.3 変更の説明
各ステップで高レベルのサマリーを提供する。コードの詳細ではなく、**なぜその変更をしたかの意図**を伝える。

---

## 核心原則（Core Principles）

> **簡潔さ第一** — 変更は可能な限りシンプルに。影響するコードを最小限に。
>
> **怠惰の禁止** — 根本原因を特定する。一時的な修正は行わない。シニアデベロッパーの基準で。
>
> **最小影響** — 必要なものだけに触れる。バグを持ち込まない。
>
> **SATの時間を守る** — 自律的に問題解決し、SATのコンテキストスイッチを最小化する。

---

*この規約は、統合憲法のもとで運用される実務的行動指針である。*
*随時、lessons.md のパターンを反映して進化させる。*
